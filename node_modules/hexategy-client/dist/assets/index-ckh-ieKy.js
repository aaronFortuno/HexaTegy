(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const W={"app.name":"HexaTegy","app.version_history":"Historial de versions","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En xarxa","lobby.mode_local_hint":"Juga en múltiples pestanyes al mateix navegador, sense servidor.","lobby.mode_online_hint":"Requereix el servidor relay actiu (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unir-se a sala","lobby.room_code":"Codi de sala","lobby.your_name":"El teu nom","lobby.join_btn":"Unir-se","lobby.create_btn":"Crear","lobby.connecting":"Connectant…","lobby.waiting":"Esperant jugadors…","lobby.players":"Jugadors","lobby.ready":"Llest","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparteix aquest codi","lobby.not_found":"Sala no trobada","config.title":"Configuració","config.round_duration":"Durada de ronda (s)","config.max_rounds":"Rondes màximes (0 = il·limitades)","config.base_production":"Producció base","config.production_per_neighbor":"Bonus per veí controlat","config.bonus_after_rounds":"Rondes per bonus continuat","config.bonus_troops":"Tropes de bonus","config.defense_advantage":"Avantatge defensor (0–1)","config.victory_condition":"Condició de victòria","config.victory_param":"Paràmetre de victòria","config.start_placement":"Col·locació inicial","config.placement_random":"Aleatòria","config.placement_clustered":"Agrupada","config.victory_total":"Conquesta total","config.victory_score":"Puntuació per rondes","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Desar configuració","config.visibility_mode":"Mode de visibilitat","config.visibility_full":"Visibilitat total","config.visibility_fog_of_war":"Boira de guerra","config.visibility_controlled_only":"Regions controlades","config.visibility_fog_strict":"Boira estricta","phase.lobby":"Sala d'espera","phase.planning":"Planificació","phase.resolving":"Resolent…","phase.ended":"Partida acabada","hud.round":"Ronda","hud.submit_orders":"Confirmar ordres","hud.cancel_all":"Cancel·lar tot","zoom.controls":"Controls de zoom","zoom.in":"Apropar","zoom.out":"Allunyar","zoom.reset":"Reiniciar zoom","end.winner":"Guanyador","end.ranking":"Classificació","end.play_again":"Tornar a jugar","end.new_room":"Nova sala","end.regions":"regions","ctx.troops":"Tropes","ctx.owner":"Propietari","ctx.neutral":"Neutral","ctx.coming_soon":"Pròximament…","waiting.no_players":"Esperant que s'hi uneixin jugadors…","waiting.kick":"Expulsar jugador","waiting.edit_name":"Editar nom","waiting.game_config":"Configuració de la partida","waiting.max_rounds_unlimited":"Il·limitades","waiting.per_neighbor":"/veí","waiting.from_round":"des de ronda","error.connection":"Error de connexió","error.room_not_found":"Sala no trobada","error.generic":"S'ha produït un error","version.title":"Historial de versions","version.close":"Tancar"},de={"app.name":"HexaTegy","app.version_history":"Historial de versiones","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En red","lobby.mode_local_hint":"Juega en múltiples pestañas del mismo navegador, sin servidor.","lobby.mode_online_hint":"Requiere el servidor relay activo (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unirse a sala","lobby.room_code":"Código de sala","lobby.your_name":"Tu nombre","lobby.join_btn":"Unirse","lobby.create_btn":"Crear","lobby.connecting":"Conectando…","lobby.waiting":"Esperando jugadores…","lobby.players":"Jugadores","lobby.ready":"Listo","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparte este código","lobby.not_found":"Sala no encontrada","config.title":"Configuración","config.round_duration":"Duración de ronda (s)","config.max_rounds":"Rondas máximas (0 = ilimitadas)","config.base_production":"Producción base","config.production_per_neighbor":"Bonus por vecino controlado","config.bonus_after_rounds":"Rondas para bonus continuado","config.bonus_troops":"Tropas de bonus","config.defense_advantage":"Ventaja defensor (0–1)","config.victory_condition":"Condición de victoria","config.victory_param":"Parámetro de victoria","config.start_placement":"Colocación inicial","config.placement_random":"Aleatoria","config.placement_clustered":"Agrupada","config.victory_total":"Conquista total","config.victory_score":"Puntuación por rondas","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Guardar configuración","config.visibility_mode":"Modo de visibilidad","config.visibility_full":"Visibilidad total","config.visibility_fog_of_war":"Niebla de guerra","config.visibility_controlled_only":"Regiones controladas","config.visibility_fog_strict":"Niebla estricta","phase.lobby":"Sala de espera","phase.planning":"Planificación","phase.resolving":"Resolviendo…","phase.ended":"Partida terminada","hud.round":"Ronda","hud.submit_orders":"Confirmar órdenes","hud.cancel_all":"Cancelar todo","zoom.controls":"Controles de zoom","zoom.in":"Acercar","zoom.out":"Alejar","zoom.reset":"Reiniciar zoom","end.winner":"Ganador","end.ranking":"Clasificación","end.play_again":"Volver a jugar","end.new_room":"Nueva sala","end.regions":"regiones","ctx.troops":"Tropas","ctx.owner":"Propietario","ctx.neutral":"Neutral","ctx.coming_soon":"Próximamente…","waiting.no_players":"Esperando que se unan jugadores…","waiting.kick":"Expulsar jugador","waiting.edit_name":"Editar nombre","waiting.game_config":"Configuración de la partida","waiting.max_rounds_unlimited":"Ilimitadas","waiting.per_neighbor":"/vecino","waiting.from_round":"desde ronda","error.connection":"Error de conexión","error.room_not_found":"Sala no encontrada","error.generic":"Se ha producido un error","version.title":"Historial de versiones","version.close":"Cerrar"},he={"app.name":"HexaTegy","app.version_history":"Version history","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"Online","lobby.mode_local_hint":"Play in multiple tabs in the same browser, no server needed.","lobby.mode_online_hint":"Requires the relay server running (ws://localhost:3001).","lobby.create":"Create room","lobby.join":"Join room","lobby.room_code":"Room code","lobby.your_name":"Your name","lobby.join_btn":"Join","lobby.create_btn":"Create","lobby.connecting":"Connecting…","lobby.waiting":"Waiting for players…","lobby.players":"Players","lobby.ready":"Ready","lobby.start_game":"Start game","lobby.room_created":"Room created:","lobby.share_code":"Share this code","lobby.not_found":"Room not found","config.title":"Settings","config.round_duration":"Round duration (s)","config.max_rounds":"Max rounds (0 = unlimited)","config.base_production":"Base production","config.production_per_neighbor":"Bonus per controlled neighbor","config.bonus_after_rounds":"Rounds for sustained bonus","config.bonus_troops":"Bonus troops","config.defense_advantage":"Defender advantage (0–1)","config.victory_condition":"Victory condition","config.victory_param":"Victory parameter","config.start_placement":"Starting placement","config.placement_random":"Random","config.placement_clustered":"Clustered","config.victory_total":"Total conquest","config.victory_score":"Score by rounds","config.victory_percent":"% of map","config.victory_hill":"Hill control","config.save":"Save settings","config.visibility_mode":"Visibility mode","config.visibility_full":"Full visibility","config.visibility_fog_of_war":"Fog of war","config.visibility_controlled_only":"Controlled regions","config.visibility_fog_strict":"Strict fog","phase.lobby":"Lobby","phase.planning":"Planning","phase.resolving":"Resolving…","phase.ended":"Game over","hud.round":"Round","hud.submit_orders":"Submit orders","hud.cancel_all":"Cancel all","zoom.controls":"Zoom controls","zoom.in":"Zoom in","zoom.out":"Zoom out","zoom.reset":"Reset zoom","end.winner":"Winner","end.ranking":"Rankings","end.play_again":"Play again","end.new_room":"New room","end.regions":"regions","ctx.troops":"Troops","ctx.owner":"Owner","ctx.neutral":"Neutral","ctx.coming_soon":"Coming soon…","waiting.no_players":"Waiting for players to join…","waiting.kick":"Kick player","waiting.edit_name":"Edit name","waiting.game_config":"Game settings","waiting.max_rounds_unlimited":"Unlimited","waiting.per_neighbor":"/neighbor","waiting.from_round":"from round","error.connection":"Connection error","error.room_not_found":"Room not found","error.generic":"An error occurred","version.title":"Version history","version.close":"Close"},V={ca:W,es:de,en:he},J="hexategy_locale";let X=W,G="ca";const O=new Set;function ue(s){return O.add(s),()=>O.delete(s)}function ge(){const s=localStorage.getItem(J),e=navigator.language.slice(0,2).toLowerCase(),t=s??(V[e]?e:"ca");Z(t)}function Z(s){const e=V[s];e&&(X=e,G=s,localStorage.setItem(J,s),document.documentElement.setAttribute("lang",s),O.forEach(t=>t()))}function me(){return G}function r(s){return X[s]??s}const pe=[{code:"ca",label:"Català"},{code:"es",label:"Castellano"},{code:"en",label:"English"}],fe=[{version:"0.1.3",date:"2026-02-24",changes:["Indicador de producció (+N) a la cantonada superior esquerra de cada cel·la pròpia","Feedback visual en drag dret: línia vermella i overlay vermell sobre la cel·la destí quan hi ha un ordre a eliminar","Correcció: el drag dret ja no mou la càmera quan s'inicia sobre una regió pròpia"]},{version:"0.1.2",date:"2026-02-24",changes:["Format automàtic del codi de sala (XXX-XXX): el guionet s'insereix sol en escriure el 4t caràcter"]},{version:"0.1.1",date:"2026-02-23",changes:["Drag dret sobre una cel·la pròpia i arrossegament a un veí elimina l'ordre planificat de moviment","Clic dret sobre una cel·la obre el menú contextual de la regió"]},{version:"0.1.0",date:"2026-02-22",changes:["Esquelet inicial del projecte","Arquitectura Admin-as-Host via relay WebSocket","Sistema de coordenades hexagonals axials","Motor de combat i producció de tropes","Condicions de victòria configurables","Zoom i pan del canvas (roda, pinch, botons)","i18n: Català, Castellà, Anglès","Modo clar / fosc","Historial de versions"]}];class ye{modal;isOpen=!1;constructor(e){this.modal=e,this.modal.innerHTML=this.renderModal(),this.bindEvents()}renderModal(){const e=fe.map(t=>`
        <article class="version-entry">
          <header class="version-entry-header">
            <span class="version-tag">v${t.version}</span>
            <time class="version-date" datetime="${t.date}">${t.date}</time>
          </header>
          <ul class="version-changes">
            ${t.changes.map(n=>`<li>${be(n)}</li>`).join("")}
          </ul>
        </article>
      `).join("");return`
      <div class="modal-backdrop" data-action="close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true"
           aria-labelledby="version-modal-title">
        <header class="modal-header">
          <h2 id="version-modal-title">${r("version.title")}</h2>
          <button class="modal-close" data-action="close" aria-label="${r("version.close")}">✕</button>
        </header>
        <div class="modal-body version-list">
          ${e}
        </div>
      </div>
    `}bindEvents(){this.modal.addEventListener("click",e=>{e.target.closest("[data-action]")?.getAttribute("data-action")==="close"&&this.close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isOpen&&this.close()})}open(){this.modal.hidden=!1,this.isOpen=!0,this.modal.querySelector(".modal-dialog")?.focus()}close(){this.modal.hidden=!0,this.isOpen=!1}toggle(){this.isOpen?this.close():this.open()}}function be(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class ve{container;versionHistory;theme;constructor(e,t){this.container=e,this.versionHistory=new ye(t),this.theme=localStorage.getItem("hexategy_theme")??"dark",document.documentElement.setAttribute("data-theme",this.theme),this.render(),this.container.addEventListener("click",this.handleClick),this.container.addEventListener("change",this.handleChange)}handleClick=e=>{const t=e.target.closest("button");t&&(t.classList.contains("version-btn")?this.versionHistory.toggle():t.classList.contains("theme-btn")&&this.toggleTheme())};handleChange=e=>{const t=e.target;t.classList.contains("locale-select")&&(Z(t.value),this.render())};render(){this.container.innerHTML=`
      <div class="header-left">
        <span class="app-name">${r("app.name")}</span>
        <button class="icon-btn version-btn"
                title="${r("app.version_history")}"
                aria-label="${r("app.version_history")}">?</button>
      </div>
      <div class="header-right">
        <select class="locale-select" aria-label="Idioma / Language">
          ${pe.map(e=>`<option value="${e.code}" ${e.code===me()?"selected":""}>${e.label}</option>`).join("")}
        </select>
        <button class="icon-btn theme-btn" title="Tema" aria-label="Canviar tema">
          ${this.theme==="dark"?"☀":"☾"}
        </button>
      </div>
    `}toggleTheme(){this.theme=this.theme==="dark"?"light":"dark",document.documentElement.setAttribute("data-theme",this.theme),localStorage.setItem("hexategy_theme",this.theme),this.render()}}const m={ROOM_CREATED:"room:created",ROOM_JOINED:"room:joined",RELAY_ERROR:"relay:error",ROOM_CREATE:"room:create",ROOM_JOIN:"room:join",GAME_STATE:"game:state",ROUND_START:"round:start",ROUND_RESOLVE:"round:resolve",GAME_OVER:"game:over",PLAYER_JOINED:"player:joined",PLAYER_LEFT:"player:left",PLAYER_READY:"player:ready",PLAYER_ORDERS:"player:orders",PLAYER_CANCEL:"player:cancel",PLAYER_KICK:"player:kick"},K={roundDuration:20,maxRounds:null,baseProduction:2,productionPerNeighbor:1,bonusAfterRounds:3,bonusTroops:3,defenseAdvantage:.55,victoryCondition:"total_conquest",victoryParam:100,startPlacement:"random",visibilityMode:"full"};function _e(){return Math.random().toString(36).slice(2,9)}function we(){return[Math.random().toString(36).slice(2,5).toUpperCase(),Math.random().toString(36).slice(2,5).toUpperCase()].join("-")}class Ee{clientId=_e();roomCode=null;isAdmin=!1;handlers=new Map;toAdminCh=null;fromAdminCh=null;connect(){return Promise.resolve()}createRoom(){this.isAdmin=!0;const e=we();this.roomCode=e,this.toAdminCh=new BroadcastChannel(`hexategy:${e}:to-admin`),this.toAdminCh.onmessage=t=>this.handleIncomingAsAdmin(t.data),this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.dispatch({type:m.ROOM_CREATED,payload:{roomCode:e,clientId:this.clientId}})}joinRoom(e,t){this.isAdmin=!1,this.roomCode=e,this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.fromAdminCh.onmessage=i=>this.dispatch(i.data);const n=new BroadcastChannel(`hexategy:${e}:to-${this.clientId}`);n.onmessage=i=>{this.dispatch(i.data),n.close()};const o=new BroadcastChannel(`hexategy:${e}:to-admin`);o.postMessage({type:m.ROOM_JOIN,from:this.clientId,payload:{roomCode:e,name:t,clientId:this.clientId}}),o.close()}send(e,t={}){const n={type:e,from:this.clientId,payload:t};if(this.isAdmin)this.fromAdminCh?.postMessage(n),this.dispatch(n);else{if(!this.roomCode)return;const o=new BroadcastChannel(`hexategy:${this.roomCode}:to-admin`);o.postMessage(n),o.close()}}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}disconnect(){this.toAdminCh?.close(),this.fromAdminCh?.close()}handleIncomingAsAdmin(e){if(e.type===m.ROOM_JOIN){const{name:t,clientId:n}=e.payload,o=new BroadcastChannel(`hexategy:${this.roomCode}:to-${n}`);o.postMessage({type:m.ROOM_JOINED,payload:{roomCode:this.roomCode,clientId:n}}),o.close();const i={type:m.PLAYER_JOINED,payload:{id:n,name:t}};this.fromAdminCh?.postMessage(i),this.dispatch(i);return}this.dispatch(e)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}}class Re{ws=null;handlers=new Map;reconnectTimer=null;url;clientId=null;roomCode=null;constructor(e){this.url=e}connect(){return new Promise((e,t)=>{this.ws=new WebSocket(this.url),this.ws.onopen=()=>e(),this.ws.onmessage=n=>{let o;try{o=JSON.parse(n.data)}catch{return}this.dispatch(o)},this.ws.onerror=()=>t(new Error("No s'ha pogut connectar al relay")),this.ws.onclose=()=>{this.dispatch({type:m.RELAY_ERROR,payload:{message:"Connexió tancada"}})}})}send(e,t={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("[relay-client] WebSocket no disponible");return}this.ws.send(JSON.stringify({type:e,payload:t}));const n={type:e,from:this.clientId??void 0,payload:t};this.dispatch(n)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}createRoom(){this.send(m.ROOM_CREATE)}joinRoom(e,t){this.send(m.ROOM_JOIN,{roomCode:e,name:t})}disconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.ws?.close(),this.ws=null}}class Ce{container;relayUrl;onJoined;mode="local";constructor(e,t,n){this.container=e,this.relayUrl=t,this.onJoined=n,this.renderMain()}renderMain(){console.log("[LobbyView] renderMain() executat"),this.container.innerHTML=`
      <section class="lobby-screen">
        <h1 class="lobby-logo">${r("lobby.title")}</h1>

        <div class="lobby-mode-toggle" role="group" aria-label="Mode de connexió">
          <button class="mode-btn ${this.mode==="local"?"active":""}" data-mode="local">
            ${r("lobby.mode_local")}
          </button>
          <button class="mode-btn ${this.mode==="online"?"active":""}" data-mode="online">
            ${r("lobby.mode_online")}
          </button>
        </div>

        ${this.mode==="online"?`
          <p class="lobby-mode-hint">${r("lobby.mode_online_hint")}</p>
        `:`
          <p class="lobby-mode-hint">${r("lobby.mode_local_hint")}</p>
        `}

        <div class="lobby-actions">
          <button class="btn btn-primary" id="btn-create">${r("lobby.create")}</button>
          <div class="lobby-divider">o</div>
          <div class="join-form">
            <input class="input" id="input-code" type="text"
                   placeholder="${r("lobby.room_code")}"
                   maxlength="7" autocomplete="off" spellcheck="false" />
            <input class="input input-name" id="input-name" type="text"
                   placeholder="${r("lobby.your_name")}"
                   maxlength="20" autocomplete="off" />
            <button class="btn btn-secondary" id="btn-join">${r("lobby.join_btn")}</button>
          </div>
        </div>

        <p class="lobby-error" id="lobby-error" hidden></p>
      </section>
    `,this.bindMain()}bindMain(){this.container.querySelectorAll(".mode-btn").forEach(t=>{t.addEventListener("click",()=>{this.mode=t.getAttribute("data-mode"),this.renderMain()})}),this.container.querySelector("#btn-create").addEventListener("click",()=>{this.handleCreate()}),this.container.querySelector("#btn-join").addEventListener("click",()=>{const t=this.container.querySelector("#input-code").value.trim().toUpperCase(),n=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(t,n)});const e=this.container.querySelector("#input-code");e.addEventListener("input",()=>{const t=e.value.replace(/[^A-Za-z0-9]/g,"").toUpperCase().slice(0,6);e.value=t.length>3?`${t.slice(0,3)}-${t.slice(3)}`:t}),this.container.querySelector("#input-code").addEventListener("keydown",t=>{if(t.key==="Enter"){const n=this.container.querySelector("#input-code").value.trim().toUpperCase(),o=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(n,o)}})}async handleCreate(){this.setLoading(!0);const e=this.createRelay();try{await e.connect()}catch{this.showError(r("error.connection"));return}e.on(m.ROOM_CREATED,t=>{const{roomCode:n,clientId:o}=t.payload;e.roomCode=n,e.clientId=o,this.onJoined(e,n,o,!0)}),e.on(m.RELAY_ERROR,t=>{const{message:n}=t.payload;this.showError(n)}),e.createRoom()}async handleJoin(e,t){if(!e||e.length<5){this.showError(r("error.room_not_found"));return}this.setLoading(!0);const n=this.createRelay();try{await n.connect()}catch{this.showError(r("error.connection"));return}n.on(m.ROOM_JOINED,o=>{const{roomCode:i,clientId:l}=o.payload;n.roomCode=i,n.clientId=l,this.onJoined(n,i,l,!1)}),n.on(m.RELAY_ERROR,o=>{const{message:i}=o.payload;this.showError(i)}),n.joinRoom(e,t)}createRelay(){return this.mode==="local"?new Ee:new Re(this.relayUrl)}setLoading(e){const t=this.container.querySelector("#btn-create"),n=this.container.querySelector("#btn-join");t&&(t.disabled=e),n&&(n.disabled=e)}showError(e){this.renderMain();const t=this.container.querySelector("#lobby-error");t&&(t.hidden=!1,t.textContent=e)}}class Ie{container;config;onChange;constructor(e,t){this.container=e,this.config={...K},this.onChange=t,this.render()}render(){this.container.innerHTML=`
      <details class="config-panel">
        <summary>${r("config.title")}</summary>
        <div class="config-grid">
          ${this.field("number","roundDuration",r("config.round_duration"),5,30)}
          ${this.field("number","maxRounds",r("config.max_rounds"),0,999)}
          ${this.field("number","baseProduction",r("config.base_production"),1,10)}
          ${this.field("number","productionPerNeighbor",r("config.production_per_neighbor"),0,5)}
          ${this.field("number","bonusAfterRounds",r("config.bonus_after_rounds"),1,20)}
          ${this.field("number","bonusTroops",r("config.bonus_troops"),0,20)}
          ${this.field("number","defenseAdvantage",r("config.defense_advantage"),0,1,.05)}
          ${this.victorySelect()}
          ${this.field("number","victoryParam",r("config.victory_param"),1,100)}
          ${this.placementSelect()}
          ${this.visibilitySelect()}
        </div>
        <button class="btn btn-secondary config-save">${r("config.save")}</button>
      </details>
    `,this.bindEvents(),this.fillValues()}field(e,t,n,o,i,l){const a=o!==void 0?`min="${o}"`:"",h=i!==void 0?`max="${i}"`:"",c=l!==void 0?`step="${l}"`:"";return`
      <label class="config-field">
        <span>${n}</span>
        <input type="${e}" data-key="${t}" ${a} ${h} ${c} />
      </label>
    `}victorySelect(){const e=[["total_conquest",r("config.victory_total")],["score_rounds",r("config.victory_score")],["map_percent",r("config.victory_percent")],["hill_control",r("config.victory_hill")]];return`
      <label class="config-field">
        <span>${r("config.victory_condition")}</span>
        <select data-key="victoryCondition">
          ${e.map(([t,n])=>`<option value="${t}">${n}</option>`).join("")}
        </select>
      </label>
    `}placementSelect(){return`
      <label class="config-field">
        <span>${r("config.start_placement")}</span>
        <select data-key="startPlacement">
          <option value="random">${r("config.placement_random")}</option>
          <option value="clustered">${r("config.placement_clustered")}</option>
        </select>
      </label>
    `}visibilitySelect(){const e=[["full",r("config.visibility_full")],["fog_of_war",r("config.visibility_fog_of_war")],["controlled_only",r("config.visibility_controlled_only")],["fog_strict",r("config.visibility_fog_strict")]];return`
      <label class="config-field">
        <span>${r("config.visibility_mode")}</span>
        <select data-key="visibilityMode">
          ${e.map(([t,n])=>`<option value="${t}">${n}</option>`).join("")}
        </select>
      </label>
    `}fillValues(){this.container.querySelectorAll("[data-key]").forEach(t=>{const n=t.getAttribute("data-key");t.value=String(this.config[n]??"")})}bindEvents(){this.container.querySelector(".config-save").addEventListener("click",()=>{this.container.querySelectorAll("[data-key]").forEach(t=>{const n=t.getAttribute("data-key"),o=t.value;t.tagName==="INPUT"&&t.type==="number"?this.config[n]=parseFloat(o):this.config[n]=o}),this.onChange({...this.config})})}getConfig(){return{...this.config}}}class Me{container;constructor(e){this.container=e}show(e,t,n,o,i){const l=t.find(c=>c.id===e),a=new Map;for(const c of n)c.ownerId&&a.set(c.ownerId,(a.get(c.ownerId)??0)+1);const h=[...t].sort((c,u)=>(a.get(u.id)??0)-(a.get(c.id)??0));this.container.innerHTML=`
      <section class="end-screen">
        <div class="end-winner" style="color: ${l?.color??"#fff"}">
          <span class="end-winner-label">${r("end.winner")}</span>
          <span class="end-winner-name">${H(l?.name??"?")}</span>
        </div>

        <table class="end-ranking" aria-label="${r("end.ranking")}">
          <thead><tr><th>#</th><th>${r("end.ranking")}</th><th>${r("end.regions")}</th></tr></thead>
          <tbody>
            ${h.map((c,u)=>`
              <tr class="${c.isEliminated?"eliminated":""}">
                <td>${u+1}</td>
                <td>
                  <span class="score-dot" style="background:${c.color}"></span>
                  ${H(c.name)}
                </td>
                <td>${a.get(c.id)??0}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="end-actions">
          <button class="btn btn-primary" id="btn-play-again">${r("end.play_again")}</button>
          <button class="btn btn-secondary" id="btn-new-room">${r("end.new_room")}</button>
        </div>
      </section>
    `,this.container.querySelector("#btn-play-again").addEventListener("click",o),this.container.querySelector("#btn-new-room").addEventListener("click",i)}}function H(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function F(s,e){return(Math.abs(s.q-e.q)+Math.abs(s.q+s.r-e.q-e.r)+Math.abs(s.r-e.r))/2}const Se=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function Le(s){return Se.map(e=>({q:s.q+e.q,r:s.r+e.r}))}function L(s){return`${s.q},${s.r}`}function Te(s,e,t=5){const n=xe(t),o=new Map(n.map(a=>[L(a),a])),i=new Map,l=n.map((a,h)=>{const c={id:`r${h}`,coord:a,ownerId:null,troops:0,neighbors:[]};return i.set(L(a),c),c});for(const a of l)a.neighbors=Le(a.coord).filter(h=>o.has(L(h))).map(h=>i.get(L(h)).id);return e.startPlacement==="random"?Ae(l,s):Pe(l,s),l}function xe(s){const e=[];for(let t=-s;t<=s;t++)for(let n=Math.max(-s,-t-s);n<=Math.min(s,-t+s);n++)e.push({q:t,r:n});return e}function Q(s){const e=[...s];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Ae(s,e){const t=Q(s);for(let n=0;n<e.length&&n<t.length;n++)t[n].ownerId=e[n],t[n].troops=3}function Pe(s,e){const t=s.filter(o=>F(o.coord,{q:0,r:0})>=Math.floor(Math.max(...s.map(i=>F(i.coord,{q:0,r:0})))*.6)),n=Q(t).slice(0,e.length);for(let o=0;o<e.length;o++)n[o]&&(n[o].ownerId=e[o],n[o].troops=3)}function $e(s,e,t){const n=new Map(s.map(c=>[c.id,c])),o=new Map,i=new Map;for(const c of e){const u=n.get(c.fromRegionId),d=n.get(c.toRegionId);if(!u||!d||!u.neighbors.includes(d.id))continue;const g=Math.min(c.troops,Math.max(0,u.troops-1));g<=0||(d.ownerId===c.playerId?(i.has(d.id)||i.set(d.id,[]),i.get(d.id).push({playerId:c.playerId,fromId:u.id,troops:g}),u.troops-=g):(o.has(d.id)||o.set(d.id,{toRegionId:d.id,attacks:[]}),o.get(d.id).attacks.push({playerId:c.playerId,fromRegionId:u.id,troops:g}),u.troops-=g))}const l=[],a=new Set;for(const[c,u]of o.entries()){const d=n.get(c),g=Oe(d,u.attacks,t);d.ownerId=g.newOwnerId,d.troops=g.newTroops,l.push({regionId:c,newOwnerId:g.newOwnerId,newTroops:g.newTroops,attackers:u.attacks.map(p=>({playerId:p.playerId,troops:p.troops}))})}for(const[c,u]of i.entries()){const d=n.get(c);for(const p of u)d.troops+=p.troops;const g=l.find(p=>p.regionId===c);g?g.newTroops=d.troops:l.push({regionId:c,newOwnerId:d.ownerId,newTroops:d.troops,attackers:[]})}const h=new Set(s.map(c=>c.ownerId).filter(Boolean));for(const c of s)c.ownerId&&!h.has(c.ownerId)&&a.add(c.ownerId);return{round:0,regionDeltas:l,eliminated:[...a],winner:null}}function Oe(s,e,t){const n=e.reduce((u,d)=>u+d.troops,0),o=s.troops,i=t.defenseAdvantage,l=1-i,a=i,h=Math.round(n*l),c=Math.round(o*a);return h>c?{newOwnerId:e.reduce((d,g)=>d.troops>g.troops?d:g).playerId,newTroops:Math.max(1,h-c)}:{newOwnerId:s.ownerId,newTroops:Math.max(1,c-h)}}const z=new Map;function ke(s,e){for(const t of s){if(!t.ownerId)continue;let n=e.baseProduction;const o=t.neighbors.filter(l=>s.find(h=>h.id===l)?.ownerId===t.ownerId);n+=o.length*e.productionPerNeighbor;const i=z.get(t.id);i&&i.ownerId===t.ownerId?(i.rounds++,i.rounds>=e.bonusAfterRounds&&(n+=e.bonusTroops)):z.set(t.id,{ownerId:t.ownerId,rounds:1}),t.troops+=n}}function De(s,e,t,n){const o=e.filter(i=>!i.isEliminated);if(o.length===0)return null;if(o.length===1)return o[0].id;switch(t.victoryCondition){case"total_conquest":return qe(s,o);case"score_rounds":return t.maxRounds&&n>=t.maxRounds?He(s,o):null;case"map_percent":{const i=t.victoryParam/100;return Be(s,o,i)}case"hill_control":return Fe(s,o,t);default:return null}}function k(s){const e=new Map;for(const t of s)t.ownerId&&e.set(t.ownerId,(e.get(t.ownerId)??0)+1);return e}function qe(s,e){const t=k(s),n=s.length;for(const o of e)if((t.get(o.id)??0)===n)return o.id;return null}function Be(s,e,t){const n=k(s),o=s.length;for(const i of e)if((n.get(i.id)??0)/o>=t)return i.id;return null}function He(s,e){const t=k(s);let n=null,o=-1;for(const i of e){const l=t.get(i.id)??0;l>o&&(o=l,n=i.id)}return n}const T=new Map;function Fe(s,e,t,n){const o=s.find(a=>a.coord.q===0&&a.coord.r===0);if(!o||!o.ownerId)return null;const i=o.ownerId,l=T.get(i)??0;T.set(i,l+1);for(const a of e)a.id!==i&&T.set(a.id,0);return(T.get(i)??0)>=t.victoryParam?i:null}class I{relay;players=new Map;regions=[];config={...K};round=0;phase="lobby";roundTimer=null;pendingOrders=new Map;static PLAYER_COLORS=["#e05c5c","#5c9ee0","#5ce07a","#e0c45c","#c45ce0","#5ce0d4","#e08c5c","#a0e05c"];colorIndex=0;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(m.PLAYER_JOINED,e=>{const{id:t,name:n}=e.payload;if(this.players.has(t))return;const o=I.PLAYER_COLORS[this.colorIndex%I.PLAYER_COLORS.length];this.colorIndex++;const i={id:t,name:n,color:o,isAdmin:!1,isReady:!1,isEliminated:!1};this.players.set(t,i),this.broadcastState()}),this.relay.on(m.PLAYER_LEFT,e=>{const{id:t}=e.payload;this.players.delete(t),this.broadcastState()}),this.relay.on(m.PLAYER_READY,e=>{const t=this.players.get(e.from??"");t&&(t.isReady=!0,this.broadcastState())}),this.relay.on(m.PLAYER_ORDERS,e=>{const{orders:t}=e.payload;this.pendingOrders.set(e.from??"",t)})}updateConfig(e){this.config={...this.config,...e},this.broadcastState()}kickPlayer(e){this.players.has(e)&&(this.players.delete(e),this.relay.send(m.PLAYER_KICK,{id:e}),this.broadcastState())}renamePlayer(e,t){const n=this.players.get(e);n&&(n.name=t.trim().slice(0,20)||n.name,this.broadcastState())}startGame(){if(this.phase!=="lobby")return;const e=[...this.players.keys()],t={id:this.relay.clientId,name:"Admin",color:I.PLAYER_COLORS[this.colorIndex%I.PLAYER_COLORS.length],isAdmin:!0,isReady:!0,isEliminated:!1};this.players.set(t.id,t),e.unshift(t.id),this.regions=Te(e,this.config),this.startRound()}static RESOLVE_GRACE_MS=1e3;startRound(){this.round++,this.phase="planning",this.pendingOrders.clear(),ke(this.regions,this.config),this.broadcastState(),this.relay.send(m.ROUND_START,{round:this.round,duration:this.config.roundDuration}),this.roundTimer=setTimeout(()=>this.resolveRound(),this.config.roundDuration*1e3+I.RESOLVE_GRACE_MS)}resolveRound(){if(this.phase!=="planning")return;this.phase="resolving";const e=[...this.pendingOrders.entries()].flatMap(([o,i])=>i.map(l=>({...l,playerId:o}))),t=$e(this.regions,e,this.config);t.round=this.round;for(const o of t.regionDeltas){const i=this.regions.find(l=>l.id===o.regionId);i&&(i.ownerId=o.newOwnerId,i.troops=o.newTroops)}for(const o of t.eliminated){const i=this.players.get(o);i&&(i.isEliminated=!0)}this.relay.send(m.ROUND_RESOLVE,t);const n=De(this.regions,[...this.players.values()],this.config,this.round);if(n){this.phase="ended",this.relay.send(m.GAME_OVER,{winnerId:n,round:this.round});return}setTimeout(()=>this.startRound(),2500)}broadcastState(){const e={players:[...this.players.values()],regions:this.regions,config:this.config,round:this.round,phase:this.phase};this.relay.send(m.GAME_STATE,e)}syncState(){this.broadcastState()}destroy(){this.roundTimer&&clearTimeout(this.roundTimer)}}class ze{relay;players=[];regions=[];config=null;round=0;phase="lobby";winnerId=null;localOrders=[];listeners=new Map;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(m.GAME_STATE,e=>{const t=e.payload;this.players=t.players,this.regions=t.regions,this.config=t.config,this.round=t.round,this.phase=t.phase,this.emit("state:updated",t)}),this.relay.on(m.ROUND_START,e=>{const{round:t,duration:n}=e.payload;this.round=t,this.phase="planning",this.localOrders=[],this.emit("round:started",{round:t,duration:n})}),this.relay.on(m.ROUND_RESOLVE,e=>{const t=e.payload;this.phase="resolving",this.emit("round:resolved",t)}),this.relay.on(m.GAME_OVER,e=>{const{winnerId:t}=e.payload;this.winnerId=t,this.phase="ended",this.emit("game:over",{winnerId:t})})}addOrder(e){this.localOrders=this.localOrders.filter(t=>!(t.fromRegionId===e.fromRegionId&&t.toRegionId===e.toRegionId)),this.localOrders.push(e)}removeOrder(e,t){this.localOrders=this.localOrders.filter(n=>!(n.fromRegionId===e&&n.toRegionId===t)),this.relay.send(m.PLAYER_CANCEL,{fromRegionId:e,toRegionId:t})}submitOrders(){this.relay.send(m.PLAYER_ORDERS,{orders:this.localOrders})}setReady(){this.relay.send(m.PLAYER_READY,{})}regionById(e){return this.regions.find(t=>t.id===e)}playerById(e){return this.players.find(t=>t.id===e)}myId(){return this.relay.clientId}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(n=>n(t))}}class Ne{state={x:0,y:0,scale:1};minScale;maxScale;zoomStep=.1;isPanning=!1;lastPanPoint={x:0,y:0};rightPanBlocked=!1;blockRightPan(e){this.rightPanBlocked=e}canvas;onChangeCallback=null;constructor(e,t){this.canvas=e,this.minScale=t?.minScale??.3,this.maxScale=t?.maxScale??4,this.attachEvents()}attachEvents(){this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detachEvents(){this.canvas.removeEventListener("wheel",this.onWheel),this.canvas.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onWheel=e=>{e.preventDefault();const t=e.deltaY>0?-this.zoomStep:this.zoomStep,n=this.canvas.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top;this.zoomAt(o,i,t)};onMouseDown=e=>{(e.button===1||e.button===2&&!this.rightPanBlocked)&&(this.isPanning=!0,this.lastPanPoint={x:e.clientX,y:e.clientY},this.canvas.style.cursor="grabbing",e.preventDefault())};onMouseMove=e=>{if(!this.isPanning)return;const t=e.clientX-this.lastPanPoint.x,n=e.clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.clientX,y:e.clientY},this.pan(t,n)};onMouseUp=e=>{(e.button===1||e.button===2)&&(this.isPanning=!1,this.canvas.style.cursor="")};lastTouchDist=0;onTouchStart=e=>{e.touches.length===2?(e.preventDefault(),this.lastTouchDist=N(e)):e.touches.length===1&&(this.isPanning=!0,this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY})};onTouchMove=e=>{if(e.touches.length===2){e.preventDefault();const t=N(e),n=Ye(e,this.canvas),o=(t-this.lastTouchDist)/this.lastTouchDist*.5;this.zoomAt(n.x,n.y,o),this.lastTouchDist=t}else if(e.touches.length===1&&this.isPanning){const t=e.touches[0].clientX-this.lastPanPoint.x,n=e.touches[0].clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.pan(t,n)}};onTouchEnd=()=>{this.isPanning=!1,this.lastTouchDist=0};zoomAt(e,t,n){const o=Math.min(this.maxScale,Math.max(this.minScale,this.state.scale+n));if(o===this.state.scale)return;const i=o/this.state.scale;this.state.x=e-i*(e-this.state.x),this.state.y=t-i*(t-this.state.y),this.state.scale=o,this.onChange()}zoomIn(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,this.zoomStep*2)}zoomOut(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,-this.zoomStep*2)}resetZoom(){this.state={x:0,y:0,scale:1},this.centerOnCanvas(),this.onChange()}pan(e,t){this.state.x+=e,this.state.y+=t,this.onChange()}centerOnCanvas(){this.state.x=this.canvas.width/2,this.state.y=this.canvas.height/2}applyToContext(e){e.setTransform(this.state.scale,0,0,this.state.scale,this.state.x,this.state.y)}canvasToWorld(e,t){return{x:(e-this.state.x)/this.state.scale,y:(t-this.state.y)/this.state.scale}}get currentScale(){return this.state.scale}get snapshot(){return{...this.state}}onChange(e){if(e){this.onChangeCallback=e;return}this.onChangeCallback?.()}}function N(s){const e=s.touches[0].clientX-s.touches[1].clientX,t=s.touches[0].clientY-s.touches[1].clientY;return Math.hypot(e,t)}function Ye(s,e){const t=e.getBoundingClientRect();return{x:(s.touches[0].clientX+s.touches[1].clientX)/2-t.left,y:(s.touches[0].clientY+s.touches[1].clientY)/2-t.top}}const P=48;function M(s,e,t=P){return{x:t*(3/2*s),y:t*(Math.sqrt(3)/2*s+Math.sqrt(3)*e)}}function je(s,e,t=P){const n=.6666666666666666*s/t,o=(-1/3*s+Math.sqrt(3)/3*e)/t;return Ue(n,o)}function Ue(s,e){const t=-s-e;let n=Math.round(s),o=Math.round(e);const i=Math.round(t),l=Math.abs(n-s),a=Math.abs(o-e),h=Math.abs(i-t);return l>a&&l>h?n=-o-i:a>h&&(o=-n-i),{q:n,r:o}}function We(s,e,t){return Array.from({length:6},(n,o)=>{const i=Math.PI/180*(60*o);return[s+t*Math.cos(i),e+t*Math.sin(i)]})}class Ve{canvas;ctx;camera;selectedRegionId=null;highlightedRegionIds=new Set;deleteTargetRegionId=null;myPlayerId=null;config=null;constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,{width:o,height:i}=this.canvas;n.clearRect(0,0,o,i),n.save(),this.camera.applyToContext(n);const l=new Map(t.map(a=>[a.id,a.color]));for(const a of e)this.drawRegion(n,a,l,e);n.restore()}drawRegion(e,t,n,o){const{x:i,y:l}=M(t.coord.q,t.coord.r),a=P-2,h=We(i,l,a);e.beginPath(),e.moveTo(h[0][0],h[0][1]);for(let d=1;d<6;d++)e.lineTo(h[d][0],h[d][1]);e.closePath();const c=t.id===this.selectedRegionId,u=this.highlightedRegionIds.has(t.id);if(t.ownerId){const d=n.get(t.ownerId)??"#888";e.fillStyle=c?Y(d,.3):u?Y(d,.15):d}else e.fillStyle=u?"rgba(200,200,200,0.4)":"rgba(120,120,120,0.3)";if(e.fill(),e.strokeStyle=c?"#fff":"rgba(0,0,0,0.4)",e.lineWidth=c?2.5:1.2,e.stroke(),t.id===this.deleteTargetRegionId&&(e.fillStyle="rgba(210, 45, 45, 0.35)",e.fill(),e.strokeStyle="rgba(210, 45, 45, 0.9)",e.lineWidth=2.5,e.stroke()),t.troops>0&&(e.fillStyle="#fff",e.font=`bold ${Math.max(11,P*.3)}px system-ui, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(t.troops),i,l)),t.ownerId&&t.ownerId===this.myPlayerId&&this.config){const d=Je(t,o,this.config),g=i-a*.44,p=l-a*.6,v=`+${d}`;e.font="bold 9px system-ui, sans-serif",e.textAlign="left",e.textBaseline="middle",e.shadowColor="rgba(0,0,0,0.7)",e.shadowBlur=3,e.fillStyle="rgba(255,255,255,0.90)",e.fillText(v,g,p),e.shadowBlur=0}}regionAt(e,t,n){const o=this.camera.canvasToWorld(e,t),{q:i,r:l}=je(o.x,o.y);return n.find(a=>a.coord.q===i&&a.coord.r===l)??null}resize(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight}}function Je(s,e,t){const n=s.neighbors.filter(o=>e.find(l=>l.id===o)?.ownerId===s.ownerId);return t.baseProduction+n.length*t.productionPerNeighbor}function Y(s,e){const t=parseInt(s.slice(1),16),n=Math.min(255,(t>>16&255)+Math.round(255*e)),o=Math.min(255,(t>>8&255)+Math.round(255*e)),i=Math.min(255,(t&255)+Math.round(255*e));return`rgb(${n},${o},${i})`}class Xe{ctx;camera;constructor(e,t){this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,o=new Map(t.map(i=>[i.id,i]));n.save(),this.camera.applyToContext(n);for(const i of e){const l=o.get(i.fromRegionId),a=o.get(i.toRegionId);if(!l||!a)continue;const h=M(l.coord.q,l.coord.r),c=M(a.coord.q,a.coord.r);i.animated&&i.progress!==void 0?this.drawAnimatedArrow(n,h,c,i):this.drawPlanningArrow(n,h,c,i)}n.restore()}drawPlanningArrow(e,t,n,o){const i=j(o.color,.72);e.save(),e.setLineDash([6,4]),e.globalAlpha=.75,e.strokeStyle="rgba(0,0,0,0.6)",e.fillStyle="rgba(0,0,0,0.6)",e.lineWidth=5.5,x(e,t.x,t.y,n.x,n.y),e.globalAlpha=.92,e.strokeStyle=i,e.fillStyle=i,e.lineWidth=2.5,x(e,t.x,t.y,n.x,n.y);const l=(t.x+n.x)/2,a=(t.y+n.y)/2,h=String(o.troops);e.setLineDash([]),e.globalAlpha=1,e.font="bold 12px system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle";const u=e.measureText(h).width+12,d=20,g=l-u/2,p=a-d/2;e.fillStyle="rgba(16, 18, 26, 0.88)",U(e,g,p,u,d,5),e.fill(),e.strokeStyle=i,e.lineWidth=1.5,U(e,g,p,u,d,5),e.stroke(),e.fillStyle="#ffffff",e.fillText(h,l,a),e.restore()}drawAnimatedArrow(e,t,n,o){const i=o.progress??0,l=t.x+(n.x-t.x)*i,a=t.y+(n.y-t.y)*i;e.globalAlpha=1-i*.3,e.fillStyle=o.color,e.beginPath(),e.arc(l,a,7,0,Math.PI*2),e.fill(),e.globalAlpha=1}drawDeleteDragArrow(e,t,n){const o=this.ctx,i="rgba(210, 45, 45, 0.85)";o.save(),this.camera.applyToContext(o),o.setLineDash([5,4]),o.globalAlpha=.4,o.strokeStyle="rgba(0,0,0,0.55)",o.lineWidth=5,o.beginPath(),o.moveTo(e.x,e.y),o.lineTo(t.x,t.y),o.stroke(),o.globalAlpha=.8,o.strokeStyle=i,o.lineWidth=2,o.beginPath(),o.moveTo(e.x,e.y),o.lineTo(t.x,t.y),o.stroke(),o.setLineDash([]),o.globalAlpha=1,o.strokeStyle=i,o.lineWidth=2.5,n?(o.beginPath(),o.moveTo(t.x-9,t.y-9),o.lineTo(t.x+9,t.y+9),o.moveTo(t.x+9,t.y-9),o.lineTo(t.x-9,t.y+9),o.stroke()):(o.globalAlpha=.6,o.beginPath(),o.arc(t.x,t.y,5,0,Math.PI*2),o.stroke()),o.restore()}drawDragArrow(e,t,n){const o=this.ctx,i=j(n,.72);o.save(),this.camera.applyToContext(o),o.setLineDash([5,4]),o.globalAlpha=.5,o.strokeStyle="rgba(0,0,0,0.55)",o.fillStyle="rgba(0,0,0,0.55)",o.lineWidth=5,x(o,e.x,e.y,t.x,t.y),o.globalAlpha=.65,o.strokeStyle=i,o.fillStyle=i,o.lineWidth=2,x(o,e.x,e.y,t.x,t.y),o.restore()}}function j(s,e){const t=parseInt(s.slice(1,3),16),n=parseInt(s.slice(3,5),16),o=parseInt(s.slice(5,7),16);return`rgb(${Math.round(t*e)},${Math.round(n*e)},${Math.round(o*e)})`}function U(s,e,t,n,o,i){s.beginPath(),s.moveTo(e+i,t),s.lineTo(e+n-i,t),s.arcTo(e+n,t,e+n,t+i,i),s.lineTo(e+n,t+o-i),s.arcTo(e+n,t+o,e+n-i,t+o,i),s.lineTo(e+i,t+o),s.arcTo(e,t+o,e,t+o-i,i),s.lineTo(e,t+i),s.arcTo(e,t,e+i,t,i),s.closePath()}function x(s,e,t,n,o){const i=Math.atan2(o-t,n-e),l=12,a=n-Math.cos(i)*14,h=o-Math.sin(i)*14;s.beginPath(),s.moveTo(e,t),s.lineTo(a,h),s.stroke(),s.setLineDash([]),s.beginPath(),s.moveTo(n,o),s.lineTo(n-l*Math.cos(i-Math.PI/6),o-l*Math.sin(i-Math.PI/6)),s.lineTo(n-l*Math.cos(i+Math.PI/6),o-l*Math.sin(i+Math.PI/6)),s.closePath(),s.fill()}class Ge{container;timerEl;phaseEl;roundEl;scoreEl;zoomControls;countdownInterval=null;constructor(e){this.container=e,this.container.innerHTML=this.template(),this.timerEl=e.querySelector(".hud-timer"),this.phaseEl=e.querySelector(".hud-phase"),this.roundEl=e.querySelector(".hud-round"),this.scoreEl=e.querySelector(".hud-score"),this.zoomControls=e.querySelector(".zoom-controls")}template(){return`
      <div class="hud-top">
        <span class="hud-round"></span>
        <span class="hud-phase"></span>
        <span class="hud-timer"></span>
      </div>
      <div class="hud-score"></div>
      <div class="zoom-controls" aria-label="${r("zoom.controls")}">
        <button class="zoom-btn" data-action="in"  aria-label="${r("zoom.in")}">+</button>
        <button class="zoom-btn" data-action="reset" aria-label="${r("zoom.reset")}">⊙</button>
        <button class="zoom-btn" data-action="out" aria-label="${r("zoom.out")}">−</button>
      </div>
    `}bindZoom(e){this.zoomControls.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(!n)return;const o=n.getAttribute("data-action");o==="in"?e.zoomIn():o==="out"?e.zoomOut():o==="reset"&&e.reset()})}updateRound(e){this.roundEl.textContent=`${r("hud.round")} ${e}`}updatePhase(e){const t={lobby:r("phase.lobby"),planning:r("phase.planning"),resolving:r("phase.resolving"),ended:r("phase.ended")};this.phaseEl.textContent=t[e]??e,this.phaseEl.dataset.phase=e}startCountdown(e,t){this.stopCountdown();let n=e;this.timerEl.textContent=String(n),this.countdownInterval=setInterval(()=>{n--,this.timerEl.textContent=String(n),n<=0&&(this.stopCountdown(),t?.())},1e3)}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null)}updateScoreboard(e,t){const n=new Map;for(const i of t)i.ownerId&&n.set(i.ownerId,(n.get(i.ownerId)??0)+1);const o=[...e].filter(i=>!i.isEliminated).sort((i,l)=>(n.get(l.id)??0)-(n.get(i.id)??0));this.scoreEl.innerHTML=o.map(i=>`
        <span class="score-entry">
          <span class="score-dot" style="background:${i.color}"></span>
          <span class="score-name">${Ze(i.name)}</span>
          <span class="score-count">${n.get(i.id)??0}</span>
        </span>
      `).join("")}}function Ze(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class Ke{canvas;hexRenderer;camera;myPlayerId;regions=[];orders=[];isDragging=!1;dragFrom=null;dragCurrentPixel=null;rightDragFrom=null;rightDownRegion=null;onOrderChange;onDragFrame=null;onRightDragFrame=null;onContextMenuCb=null;constructor(e,t,n,o,i){this.canvas=e,this.hexRenderer=t,this.camera=n,this.myPlayerId=o,this.onOrderChange=i,this.attachEvents()}updateState(e,t){this.regions=e,this.orders=t}onDrag(e){this.onDragFrame=e}onRightDrag(e){this.onRightDragFrame=e}onContextMenu(e){this.onContextMenuCb=e}attachEvents(){this.canvas.addEventListener("mousedown",this.onMouseDown,{capture:!0}),this.canvas.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("contextmenu",this.preventContextMenu),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detach(){this.canvas.removeEventListener("mousedown",this.onMouseDown,{capture:!0}),this.canvas.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("contextmenu",this.preventContextMenu),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onMouseDown=e=>{if(e.button===0){const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);if(!n||n.ownerId!==this.myPlayerId)return;this.isDragging=!0,this.dragFrom=n,this.dragCurrentPixel=t,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors)}else if(e.button===2){const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);this.rightDownRegion=n??null,n?.ownerId===this.myPlayerId&&(this.rightDragFrom=n,this.camera.blockRightPan(!0))}};onMouseMove=e=>{const t=this.canvasPos(e);if(this.isDragging&&this.dragFrom){this.dragCurrentPixel=t;const n=M(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)}if(this.rightDragFrom){const n=M(this.rightDragFrom.coord.q,this.rightDragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y),i=this.hexRenderer.regionAt(t.x,t.y,this.regions),l=i!==null&&i.id!==this.rightDragFrom.id&&this.rightDragFrom.neighbors.includes(i.id)&&this.orders.some(a=>a.fromRegionId===this.rightDragFrom.id&&a.toRegionId===i.id);this.onRightDragFrame?.(n,o,l?i.id:null)}};onMouseUp=e=>{if(e.button===0){if(!this.isDragging||!this.dragFrom)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&n.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(n.id)&&this.createOrUpdateOrder(this.dragFrom,n),this.endDrag()}else if(e.button===2){if(!this.rightDownRegion&&!this.rightDragFrom)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&this.rightDownRegion?.id===n.id?this.onContextMenuCb?.(n,e.clientX,e.clientY):this.rightDragFrom&&n&&n.id!==this.rightDragFrom.id&&this.removeOrder(this.rightDragFrom.id,n.id),this.rightDragFrom=null,this.rightDownRegion=null,this.camera.blockRightPan(!1),this.onRightDragFrame?.(null,null,null)}};preventContextMenu=e=>{e.preventDefault()};onTouchStart=e=>{if(e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);!n||n.ownerId!==this.myPlayerId||(this.isDragging=!0,this.dragFrom=n,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors))};onTouchMove=e=>{if(!this.isDragging||!this.dragFrom||e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]);this.dragCurrentPixel=t;const n=M(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)};onTouchEnd=e=>{if(!(!this.isDragging||!this.dragFrom)){if(this.dragCurrentPixel){const t=this.hexRenderer.regionAt(this.dragCurrentPixel.x,this.dragCurrentPixel.y,this.regions);t&&t.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(t.id)&&this.createOrUpdateOrder(this.dragFrom,t)}this.endDrag()}};createOrUpdateOrder(e,t){if(this.orders.find(a=>a.fromRegionId===e.id&&a.toRegionId===t.id))return;const o=this.orders.filter(a=>a.fromRegionId===e.id),i=Math.max(0,e.troops-1),l=Math.floor(i/(o.length+1));for(const a of o)a.troops=l;this.orders.push({fromRegionId:e.id,toRegionId:t.id,troops:l}),this.onOrderChange([...this.orders])}removeOrder(e,t){const n=this.orders.length;this.orders=this.orders.filter(o=>!(o.fromRegionId===e&&o.toRegionId===t)),this.orders.length!==n&&this.onOrderChange([...this.orders])}endDrag(){this.isDragging=!1,this.dragFrom=null,this.dragCurrentPixel=null,this.onDragFrame?.({x:0,y:0},{x:0,y:0}),this.hexRenderer.selectedRegionId=null,this.hexRenderer.highlightedRegionIds=new Set}canvasPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}touchPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}}const Qe={},et=Qe?.VITE_RELAY_URL??"ws://localhost:3001";function A(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}console.log("[HexaTegy] main.ts carregat, iniciant bootstrap…");ge();console.log("[HexaTegy] initI18n() completat");const ee=document.getElementById("app-header"),S=document.getElementById("app-root"),te=document.getElementById("version-history-modal");console.log("[HexaTegy] Elements DOM:",{headerEl:ee,rootEl:S,versionModal:te});const tt=new ve(ee,te);console.log("[HexaTegy] AppHeader creat correctament");let $=null;function D(){console.log("[HexaTegy] showLobby() iniciant…"),$?.(),S.innerHTML="",new Ce(S,et,(s,e,t,n)=>{$?.(),ne(s,e,t,n)}),console.log("[HexaTegy] LobbyView creat, esperant acció de l'usuari"),$=ue(()=>{tt.render(),D()})}function ne(s,e,t,n){S.innerHTML=`
    <section class="waiting-room">
      <div class="room-code-block">
        <span class="room-code-label">Sala</span>
        <strong class="room-code">${e}</strong>
      </div>
      <div id="config-panel-mount"></div>
      <div id="config-preview" class="config-preview"></div>
      <div id="player-list" class="player-list">
        <p class="player-list-empty">${r("waiting.no_players")}</p>
      </div>
      ${n?`<button class="btn btn-primary" id="btn-start" disabled>${r("lobby.start_game")}</button>`:`<button class="btn btn-secondary" id="btn-ready">${r("lobby.ready")}</button>`}
    </section>
  `;let o=null,i=!1;function l(h){const c=document.getElementById("player-list");if(c){if(h.length===0){c.innerHTML=`<p class="player-list-empty">${r("waiting.no_players")}</p>`;return}c.innerHTML=h.map(u=>{const d=u.id===t,g=[u.isAdmin?'<span class="player-badge player-badge--admin">admin</span>':"",d?'<span class="player-badge player-badge--me">tu</span>':"",u.isReady?`<span class="player-badge player-badge--ready">${r("lobby.ready")}</span>`:""].join(""),p=n&&!d?`<button class="btn-icon-sm btn-edit-name" data-id="${u.id}" title="${r("waiting.edit_name")}">✎</button>`:"",v=n&&!d?`<button class="btn-icon-sm btn-kick" data-id="${u.id}" title="${r("waiting.kick")}">✕</button>`:"";return`
          <div class="player-item" data-id="${u.id}">
            <span class="player-dot" style="background:${u.color}"></span>
            <span class="player-name">${A(u.name)}</span>
            ${g}
            <span class="player-item-actions">${p}${v}</span>
          </div>`}).join(""),c.querySelectorAll(".btn-kick[data-id]").forEach(u=>{u.addEventListener("click",()=>o?.kickPlayer(u.dataset.id))}),c.querySelectorAll(".btn-edit-name[data-id]").forEach(u=>{u.addEventListener("click",()=>{const d=u.dataset.id,g=c.querySelector(`.player-item[data-id="${d}"]`);if(!g)return;const p=g.querySelector(".player-name");if(!p||g.querySelector(".player-name-input"))return;const v=p.textContent?.trim()??"",f=document.createElement("input");f.className="input player-name-input",f.value=v,f.maxLength=20,p.replaceWith(f),f.focus(),f.select();const w=()=>{const R=f.value.trim();R&&R!==v?o?.renamePlayer(d,R):f.replaceWith(p)};f.addEventListener("blur",w),f.addEventListener("keydown",R=>{R.key==="Enter"&&f.blur(),R.key==="Escape"&&(f.removeEventListener("blur",w),f.replaceWith(p))})})})}}function a(h){const c=document.getElementById("config-preview");if(!c)return;const u={full:r("config.visibility_full"),fog_of_war:r("config.visibility_fog_of_war"),controlled_only:r("config.visibility_controlled_only"),fog_strict:r("config.visibility_fog_strict")},d={total_conquest:r("config.victory_total"),score_rounds:r("config.victory_score"),map_percent:r("config.victory_percent"),hill_control:r("config.victory_hill")},g={random:r("config.placement_random"),clustered:r("config.placement_clustered")},p=!h.maxRounds||h.maxRounds===0?r("waiting.max_rounds_unlimited"):String(h.maxRounds),v=[[r("config.visibility_mode"),u[h.visibilityMode]??h.visibilityMode],[r("config.victory_condition"),`${d[h.victoryCondition]??h.victoryCondition} (${h.victoryParam})`],[r("config.round_duration"),`${h.roundDuration}s`],[r("config.max_rounds"),p],[r("config.base_production"),`${h.baseProduction} + ${h.productionPerNeighbor}${r("waiting.per_neighbor")}`],[r("config.bonus_after_rounds"),`+${h.bonusTroops} ${r("waiting.from_round")} ${h.bonusAfterRounds}`],[r("config.defense_advantage"),`${Math.round(h.defenseAdvantage*100)}%`],[r("config.start_placement"),g[h.startPlacement]??h.startPlacement]];c.innerHTML=`
      <h3 class="config-preview-title">${r("waiting.game_config")}</h3>
      <dl class="config-preview-grid">
        ${v.map(([f,w])=>`<dt>${A(f)}</dt><dd>${A(w)}</dd>`).join("")}
      </dl>
    `}if(n){o=new I(s);const h=document.getElementById("config-panel-mount");new Ie(h,u=>o.updateConfig(u)),document.getElementById("btn-start").addEventListener("click",()=>o.startGame())}else{const h=document.getElementById("btn-ready");h.addEventListener("click",()=>{s.send(m.PLAYER_READY,{}),h.disabled=!0})}s.on(m.GAME_STATE,h=>{if(i)return;const c=h.payload;if(c.phase==="lobby"){if(l(c.players??[]),c.config&&a(c.config),n){const u=document.getElementById("btn-start");u&&(u.disabled=(c.players??[]).length<1)}}else(c.phase==="planning"||c.phase==="resolving")&&(i=!0,nt(s,t,n,o))})}function nt(s,e,t,n){S.innerHTML=`
    <div class="game-layout">
      <canvas id="game-canvas" class="game-canvas"></canvas>
      <div id="hud-overlay" class="hud-overlay"></div>
    </div>
  `;const o=document.getElementById("game-canvas"),i=document.getElementById("hud-overlay");function l(){o.width=o.offsetWidth,o.height=o.offsetHeight,E()}o.width=o.offsetWidth,o.height=o.offsetHeight,window.addEventListener("resize",l),o.addEventListener("contextmenu",y=>y.preventDefault());const a=new Ne(o,{minScale:.25,maxScale:5});a.centerOnCanvas(),a.onChange(()=>E());const h=new Ve(o,a);h.myPlayerId=e;const c=new Xe(o,a),u=new Ge(i),d=new ze(s);t&&n&&n.syncState();let g=[],p=[],v=null,f=null;u.bindZoom({zoomIn:()=>a.zoomIn(),zoomOut:()=>a.zoomOut(),reset:()=>{a.resetZoom(),a.centerOnCanvas()}});const w=new Ke(o,h,a,e,y=>{g=y,d.localOrders=y,E()});w.onDrag((y,b)=>{const _=d.playerById(e);v=y.x!==0||b.x!==0?{from:y,to:b,color:_?.color??"#fff"}:null,E()}),w.onRightDrag((y,b,_)=>{!y||!b?(f=null,h.deleteTargetRegionId=null):(f={from:y,to:b,hasValidTarget:_!==null},h.deleteTargetRegionId=_),E()}),w.onContextMenu((y,b,_)=>{R(y,b,_)});function R(y,b,_){document.getElementById("region-ctx-menu")?.remove();const q=y.ownerId?d.playerById(y.ownerId):null,oe=q?.name??r("ctx.neutral"),ie=q?.color??"var(--text-muted)",C=document.createElement("div");C.id="region-ctx-menu",C.className="region-ctx-menu";const se=172,re=72,ae=Math.min(b+4,window.innerWidth-se-8),le=Math.min(_+4,window.innerHeight-re-8);C.style.left=`${ae}px`,C.style.top=`${le}px`,C.innerHTML=`
      <div class="ctx-header">
        <span class="ctx-troops">⚔ ${y.troops}</span>
        <span class="ctx-owner" style="color:${ie}">${A(oe)}</span>
      </div>
      <button class="ctx-item" disabled>${r("ctx.coming_soon")}</button>
    `,document.body.appendChild(C);const B=ce=>{C.contains(ce.target)||(C.remove(),document.removeEventListener("mousedown",B))};setTimeout(()=>document.addEventListener("mousedown",B),0)}function E(){h.render(d.regions,d.players);const y=d.playerById(e),b=g.map(_=>({fromRegionId:_.fromRegionId,toRegionId:_.toRegionId,troops:_.troops,color:y?.color??"#fff"}));c.render([...b,...p],d.regions),v&&c.drawDragArrow(v.from,v.to,v.color),f&&c.drawDeleteDragArrow(f.from,f.to,f.hasValidTarget)}d.on("state:updated",()=>{h.config=d.config,u.updateRound(d.round),u.updatePhase(d.phase),u.updateScoreboard(d.players,d.regions),w.updateState(d.regions,g),E()}),d.on("round:started",y=>{const{duration:b}=y;g=[],p=[],d.localOrders=[],w.updateState(d.regions,g),u.startCountdown(b,()=>d.submitOrders()),E()}),d.on("round:resolved",()=>{u.stopCountdown(),setTimeout(()=>E(),2200)}),d.on("game:over",y=>{const{winnerId:b}=y;window.removeEventListener("resize",l),a.detachEvents(),w.detach(),ot(s,b,d,n)}),E()}function ot(s,e,t,n){new Me(S).show(e,t.players,t.regions,()=>ne(s,s.roomCode??"",s.clientId??"",n!==null),()=>{s.disconnect(),n?.destroy(),D()})}try{D()}catch(s){console.error("[HexaTegy] ERROR FATAL a showLobby():",s),document.getElementById("app-root").innerHTML=`<div style="padding:2rem;color:#e05c5c;font-family:monospace">
       <b>Error d'inicialització</b><br><pre>${String(s)}</pre>
       <p>Consulta la consola del navegador per més detalls.</p>
     </div>`}
