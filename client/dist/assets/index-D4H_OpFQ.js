(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();const V={"app.name":"HexaTegy","app.version_history":"Historial de versions","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En xarxa","lobby.mode_local_hint":"Juga en múltiples pestanyes al mateix navegador, sense servidor.","lobby.mode_online_hint":"Requereix el servidor relay actiu (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unir-se a sala","lobby.room_code":"Codi de sala","lobby.your_name":"El teu nom","lobby.join_btn":"Unir-se","lobby.create_btn":"Crear","lobby.connecting":"Connectant…","lobby.waiting":"Esperant jugadors…","lobby.players":"Jugadors","lobby.ready":"Llest","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparteix aquest codi","lobby.not_found":"Sala no trobada","config.title":"Configuració","config.round_duration":"Durada de ronda (s)","config.max_rounds":"Rondes màximes (0 = il·limitades)","config.base_production":"Producció base","config.production_per_neighbor":"Bonus per veí controlat","config.bonus_after_rounds":"Rondes per bonus continuat","config.bonus_troops":"Tropes de bonus","config.defense_advantage":"Avantatge defensor (0–1)","config.victory_condition":"Condició de victòria","config.victory_param":"Paràmetre de victòria","config.start_placement":"Col·locació inicial","config.placement_random":"Aleatòria","config.placement_clustered":"Agrupada","config.start_regions":"Regions inicials per jugador","config.victory_total":"Conquesta total","config.victory_score":"Puntuació per rondes","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Desar configuració","config.visibility_mode":"Mode de visibilitat","config.visibility_full":"Visibilitat total","config.visibility_fog_of_war":"Boira de guerra","config.visibility_fog_strict":"Boira estricta","phase.lobby":"Sala d'espera","phase.planning":"Planificació","phase.resolving":"Resolent…","phase.ended":"Partida acabada","hud.round":"Ronda","hud.submit_orders":"Confirmar ordres","hud.cancel_all":"Cancel·lar tot","zoom.controls":"Controls de zoom","zoom.in":"Apropar","zoom.out":"Allunyar","zoom.reset":"Reiniciar zoom","end.winner":"Guanyador","end.ranking":"Classificació","end.play_again":"Tornar a jugar","end.new_room":"Nova sala","end.regions":"regions","ctx.troops":"Tropes","ctx.owner":"Propietari","ctx.neutral":"Neutral","ctx.coming_soon":"Pròximament…","waiting.no_players":"Esperant que s'hi uneixin jugadors…","waiting.kick":"Expulsar jugador","waiting.edit_name":"Editar nom","waiting.game_config":"Configuració de la partida","waiting.max_rounds_unlimited":"Il·limitades","waiting.per_neighbor":"/veí","waiting.from_round":"des de ronda","error.connection":"Error de connexió","error.room_not_found":"Sala no trobada","error.generic":"S'ha produït un error","version.title":"Historial de versions","version.close":"Tancar"},he={"app.name":"HexaTegy","app.version_history":"Historial de versiones","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En red","lobby.mode_local_hint":"Juega en múltiples pestañas del mismo navegador, sin servidor.","lobby.mode_online_hint":"Requiere el servidor relay activo (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unirse a sala","lobby.room_code":"Código de sala","lobby.your_name":"Tu nombre","lobby.join_btn":"Unirse","lobby.create_btn":"Crear","lobby.connecting":"Conectando…","lobby.waiting":"Esperando jugadores…","lobby.players":"Jugadores","lobby.ready":"Listo","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparte este código","lobby.not_found":"Sala no encontrada","config.title":"Configuración","config.round_duration":"Duración de ronda (s)","config.max_rounds":"Rondas máximas (0 = ilimitadas)","config.base_production":"Producción base","config.production_per_neighbor":"Bonus por vecino controlado","config.bonus_after_rounds":"Rondas para bonus continuado","config.bonus_troops":"Tropas de bonus","config.defense_advantage":"Ventaja defensor (0–1)","config.victory_condition":"Condición de victoria","config.victory_param":"Parámetro de victoria","config.start_placement":"Colocación inicial","config.placement_random":"Aleatoria","config.placement_clustered":"Agrupada","config.start_regions":"Regiones iniciales por jugador","config.victory_total":"Conquista total","config.victory_score":"Puntuación por rondas","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Guardar configuración","config.visibility_mode":"Modo de visibilidad","config.visibility_full":"Visibilidad total","config.visibility_fog_of_war":"Niebla de guerra","config.visibility_fog_strict":"Niebla estricta","phase.lobby":"Sala de espera","phase.planning":"Planificación","phase.resolving":"Resolviendo…","phase.ended":"Partida terminada","hud.round":"Ronda","hud.submit_orders":"Confirmar órdenes","hud.cancel_all":"Cancelar todo","zoom.controls":"Controles de zoom","zoom.in":"Acercar","zoom.out":"Alejar","zoom.reset":"Reiniciar zoom","end.winner":"Ganador","end.ranking":"Clasificación","end.play_again":"Volver a jugar","end.new_room":"Nueva sala","end.regions":"regiones","ctx.troops":"Tropas","ctx.owner":"Propietario","ctx.neutral":"Neutral","ctx.coming_soon":"Próximamente…","waiting.no_players":"Esperando que se unan jugadores…","waiting.kick":"Expulsar jugador","waiting.edit_name":"Editar nombre","waiting.game_config":"Configuración de la partida","waiting.max_rounds_unlimited":"Ilimitadas","waiting.per_neighbor":"/vecino","waiting.from_round":"desde ronda","error.connection":"Error de conexión","error.room_not_found":"Sala no encontrada","error.generic":"Se ha producido un error","version.title":"Historial de versiones","version.close":"Cerrar"},ue={"app.name":"HexaTegy","app.version_history":"Version history","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"Online","lobby.mode_local_hint":"Play in multiple tabs in the same browser, no server needed.","lobby.mode_online_hint":"Requires the relay server running (ws://localhost:3001).","lobby.create":"Create room","lobby.join":"Join room","lobby.room_code":"Room code","lobby.your_name":"Your name","lobby.join_btn":"Join","lobby.create_btn":"Create","lobby.connecting":"Connecting…","lobby.waiting":"Waiting for players…","lobby.players":"Players","lobby.ready":"Ready","lobby.start_game":"Start game","lobby.room_created":"Room created:","lobby.share_code":"Share this code","lobby.not_found":"Room not found","config.title":"Settings","config.round_duration":"Round duration (s)","config.max_rounds":"Max rounds (0 = unlimited)","config.base_production":"Base production","config.production_per_neighbor":"Bonus per controlled neighbor","config.bonus_after_rounds":"Rounds for sustained bonus","config.bonus_troops":"Bonus troops","config.defense_advantage":"Defender advantage (0–1)","config.victory_condition":"Victory condition","config.victory_param":"Victory parameter","config.start_placement":"Starting placement","config.placement_random":"Random","config.placement_clustered":"Clustered","config.start_regions":"Starting regions per player","config.victory_total":"Total conquest","config.victory_score":"Score by rounds","config.victory_percent":"% of map","config.victory_hill":"Hill control","config.save":"Save settings","config.visibility_mode":"Visibility mode","config.visibility_full":"Full visibility","config.visibility_fog_of_war":"Fog of war","config.visibility_fog_strict":"Strict fog","phase.lobby":"Lobby","phase.planning":"Planning","phase.resolving":"Resolving…","phase.ended":"Game over","hud.round":"Round","hud.submit_orders":"Submit orders","hud.cancel_all":"Cancel all","zoom.controls":"Zoom controls","zoom.in":"Zoom in","zoom.out":"Zoom out","zoom.reset":"Reset zoom","end.winner":"Winner","end.ranking":"Rankings","end.play_again":"Play again","end.new_room":"New room","end.regions":"regions","ctx.troops":"Troops","ctx.owner":"Owner","ctx.neutral":"Neutral","ctx.coming_soon":"Coming soon…","waiting.no_players":"Waiting for players to join…","waiting.kick":"Kick player","waiting.edit_name":"Edit name","waiting.game_config":"Game settings","waiting.max_rounds_unlimited":"Unlimited","waiting.per_neighbor":"/neighbor","waiting.from_round":"from round","error.connection":"Connection error","error.room_not_found":"Room not found","error.generic":"An error occurred","version.title":"Version history","version.close":"Close"},J={ca:V,es:he,en:ue},X="hexategy_locale";let G=V,Z="ca";const k=new Set;function ge(s){return k.add(s),()=>k.delete(s)}function me(){const s=localStorage.getItem(X),e=navigator.language.slice(0,2).toLowerCase(),t=s??(J[e]?e:"ca");K(t)}function K(s){const e=J[s];e&&(G=e,Z=s,localStorage.setItem(X,s),document.documentElement.setAttribute("lang",s),k.forEach(t=>t()))}function pe(){return Z}function c(s){return G[s]??s}const fe=[{code:"ca",label:"Català"},{code:"es",label:"Castellano"},{code:"en",label:"English"}],ye=[{version:"0.1.7",date:"2026-02-25",changes:["Nova opció de configuració: 'Regions inicials per jugador' (1–5), vinculada al mode de col·locació inicial","La col·locació expandeix el territori de cada jugador de forma aleatòria i equitativa entre veïns lliures","Boira de guerra i Boira estricta: les regions adjacents directes ara mostren sempre el nombre de tropes actuals (sense increment de producció, que continua ocult per a regions alienes)"]},{version:"0.1.6",date:"2026-02-25",changes:["Correcció: les regions acabades de conquistar no reben producció el torn de la conquesta (evita inflació de tropes immediata)","Correcció: múltiples ordres des de la mateixa regió ara es distribueixen proporcionalment al servidor, garantint que mai es creïn tropes del no-res","Correcció: eliminar una ruta planificada ara redistribueix les tropes alliberades equitativament entre les rutes restants del mateix origen","TODO: opció de configuració per al nombre de regions inicials per jugador (ara sempre 1)"]},{version:"0.1.5",date:"2026-02-25",changes:["La configuració de partida s'aplica immediatament en canviar cada camp, sense necessitat de prémer 'Desar'","Sala d'espera redissenyada en dues columnes: configuració a l'esquerra, llista de jugadors a la dreta","Mode de visibilitat 'Regions controlades' eliminat (no tenia comportament clar definit)","Implementació real de la boira de guerra: 'Boira de guerra' oculta tropes enemigues; 'Boira estricta' amaga regions fora de l'abast immediat"]},{version:"0.1.4",date:"2026-02-24",changes:["Correcció: regions neutrals amb 0 tropes ara es capturen correctament (l'atacant hi entra amb totes les tropes enviades, sense reducció per fórmula)","Correcció: regions que rebien 1 sola tropa quedaven permanentment neutrals sense color ni producció — resolt amb el cas especial anterior","Correcció: el comptador de ronda usava setInterval acumulant ~300 ms de deriva; ara la crida d'enviament d'ordres usa setTimeout per disparar-se en el moment exacte","Configuració de partida visible en temps real a la sala d'espera per a tots els clients","Nou selector de mode de visibilitat a la configuració (Visibilitat total, Boira de guerra, Regions controlades, Boira estricta)"]},{version:"0.1.3",date:"2026-02-24",changes:["Indicador de producció (+N) a la cantonada superior esquerra de cada cel·la pròpia","Feedback visual en drag dret: línia vermella i overlay vermell sobre la cel·la destí quan hi ha un ordre a eliminar","Correcció: el drag dret ja no mou la càmera quan s'inicia sobre una regió pròpia"]},{version:"0.1.2",date:"2026-02-24",changes:["Format automàtic del codi de sala (XXX-XXX): el guionet s'insereix sol en escriure el 4t caràcter"]},{version:"0.1.1",date:"2026-02-23",changes:["Drag dret sobre una cel·la pròpia i arrossegament a un veí elimina l'ordre planificat de moviment","Clic dret sobre una cel·la obre el menú contextual de la regió"]},{version:"0.1.0",date:"2026-02-22",changes:["Esquelet inicial del projecte","Arquitectura Admin-as-Host via relay WebSocket","Sistema de coordenades hexagonals axials","Motor de combat i producció de tropes","Condicions de victòria configurables","Zoom i pan del canvas (roda, pinch, botons)","i18n: Català, Castellà, Anglès","Modo clar / fosc","Historial de versions"]}];class be{modal;isOpen=!1;constructor(e){this.modal=e,this.modal.innerHTML=this.renderModal(),this.bindEvents()}renderModal(){const e=ye.map(t=>`
        <article class="version-entry">
          <header class="version-entry-header">
            <span class="version-tag">v${t.version}</span>
            <time class="version-date" datetime="${t.date}">${t.date}</time>
          </header>
          <ul class="version-changes">
            ${t.changes.map(n=>`<li>${ve(n)}</li>`).join("")}
          </ul>
        </article>
      `).join("");return`
      <div class="modal-backdrop" data-action="close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true"
           aria-labelledby="version-modal-title">
        <header class="modal-header">
          <h2 id="version-modal-title">${c("version.title")}</h2>
          <button class="modal-close" data-action="close" aria-label="${c("version.close")}">✕</button>
        </header>
        <div class="modal-body version-list">
          ${e}
        </div>
      </div>
    `}bindEvents(){this.modal.addEventListener("click",e=>{e.target.closest("[data-action]")?.getAttribute("data-action")==="close"&&this.close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isOpen&&this.close()})}open(){this.modal.hidden=!1,this.isOpen=!0,this.modal.querySelector(".modal-dialog")?.focus()}close(){this.modal.hidden=!0,this.isOpen=!1}toggle(){this.isOpen?this.close():this.open()}}function ve(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class we{container;versionHistory;theme;constructor(e,t){this.container=e,this.versionHistory=new be(t),this.theme=localStorage.getItem("hexategy_theme")??"dark",document.documentElement.setAttribute("data-theme",this.theme),this.render(),this.container.addEventListener("click",this.handleClick),this.container.addEventListener("change",this.handleChange)}handleClick=e=>{const t=e.target.closest("button");t&&(t.classList.contains("version-btn")?this.versionHistory.toggle():t.classList.contains("theme-btn")&&this.toggleTheme())};handleChange=e=>{const t=e.target;t.classList.contains("locale-select")&&(K(t.value),this.render())};render(){this.container.innerHTML=`
      <div class="header-left">
        <span class="app-name">${c("app.name")}</span>
        <button class="icon-btn version-btn"
                title="${c("app.version_history")}"
                aria-label="${c("app.version_history")}">?</button>
      </div>
      <div class="header-right">
        <select class="locale-select" aria-label="Idioma / Language">
          ${fe.map(e=>`<option value="${e.code}" ${e.code===pe()?"selected":""}>${e.label}</option>`).join("")}
        </select>
        <button class="icon-btn theme-btn" title="Tema" aria-label="Canviar tema">
          ${this.theme==="dark"?"☀":"☾"}
        </button>
      </div>
    `}toggleTheme(){this.theme=this.theme==="dark"?"light":"dark",document.documentElement.setAttribute("data-theme",this.theme),localStorage.setItem("hexategy_theme",this.theme),this.render()}}const p={ROOM_CREATED:"room:created",ROOM_JOINED:"room:joined",RELAY_ERROR:"relay:error",ROOM_CREATE:"room:create",ROOM_JOIN:"room:join",GAME_STATE:"game:state",ROUND_START:"round:start",ROUND_RESOLVE:"round:resolve",GAME_OVER:"game:over",PLAYER_JOINED:"player:joined",PLAYER_LEFT:"player:left",PLAYER_READY:"player:ready",PLAYER_ORDERS:"player:orders",PLAYER_CANCEL:"player:cancel",PLAYER_KICK:"player:kick"},Q={roundDuration:20,maxRounds:null,baseProduction:2,productionPerNeighbor:1,bonusAfterRounds:3,bonusTroops:3,defenseAdvantage:.55,victoryCondition:"total_conquest",victoryParam:100,startPlacement:"random",startRegions:1,visibilityMode:"full"};function _e(){return Math.random().toString(36).slice(2,9)}function Re(){return[Math.random().toString(36).slice(2,5).toUpperCase(),Math.random().toString(36).slice(2,5).toUpperCase()].join("-")}class Ee{clientId=_e();roomCode=null;isAdmin=!1;handlers=new Map;toAdminCh=null;fromAdminCh=null;connect(){return Promise.resolve()}createRoom(){this.isAdmin=!0;const e=Re();this.roomCode=e,this.toAdminCh=new BroadcastChannel(`hexategy:${e}:to-admin`),this.toAdminCh.onmessage=t=>this.handleIncomingAsAdmin(t.data),this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.dispatch({type:p.ROOM_CREATED,payload:{roomCode:e,clientId:this.clientId}})}joinRoom(e,t){this.isAdmin=!1,this.roomCode=e,this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.fromAdminCh.onmessage=i=>this.dispatch(i.data);const n=new BroadcastChannel(`hexategy:${e}:to-${this.clientId}`);n.onmessage=i=>{this.dispatch(i.data),n.close()};const o=new BroadcastChannel(`hexategy:${e}:to-admin`);o.postMessage({type:p.ROOM_JOIN,from:this.clientId,payload:{roomCode:e,name:t,clientId:this.clientId}}),o.close()}send(e,t={}){const n={type:e,from:this.clientId,payload:t};if(this.isAdmin)this.fromAdminCh?.postMessage(n),this.dispatch(n);else{if(!this.roomCode)return;const o=new BroadcastChannel(`hexategy:${this.roomCode}:to-admin`);o.postMessage(n),o.close()}}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}disconnect(){this.toAdminCh?.close(),this.fromAdminCh?.close()}handleIncomingAsAdmin(e){if(e.type===p.ROOM_JOIN){const{name:t,clientId:n}=e.payload,o=new BroadcastChannel(`hexategy:${this.roomCode}:to-${n}`);o.postMessage({type:p.ROOM_JOINED,payload:{roomCode:this.roomCode,clientId:n}}),o.close();const i={type:p.PLAYER_JOINED,payload:{id:n,name:t}};this.fromAdminCh?.postMessage(i),this.dispatch(i);return}this.dispatch(e)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}}class Ie{ws=null;handlers=new Map;reconnectTimer=null;url;clientId=null;roomCode=null;constructor(e){this.url=e}connect(){return new Promise((e,t)=>{this.ws=new WebSocket(this.url),this.ws.onopen=()=>e(),this.ws.onmessage=n=>{let o;try{o=JSON.parse(n.data)}catch{return}this.dispatch(o)},this.ws.onerror=()=>t(new Error("No s'ha pogut connectar al relay")),this.ws.onclose=()=>{this.dispatch({type:p.RELAY_ERROR,payload:{message:"Connexió tancada"}})}})}send(e,t={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("[relay-client] WebSocket no disponible");return}this.ws.send(JSON.stringify({type:e,payload:t}));const n={type:e,from:this.clientId??void 0,payload:t};this.dispatch(n)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}createRoom(){this.send(p.ROOM_CREATE)}joinRoom(e,t){this.send(p.ROOM_JOIN,{roomCode:e,name:t})}disconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.ws?.close(),this.ws=null}}class Ce{container;relayUrl;onJoined;mode="local";constructor(e,t,n){this.container=e,this.relayUrl=t,this.onJoined=n,this.renderMain()}renderMain(){console.log("[LobbyView] renderMain() executat"),this.container.innerHTML=`
      <section class="lobby-screen">
        <h1 class="lobby-logo">${c("lobby.title")}</h1>

        <div class="lobby-mode-toggle" role="group" aria-label="Mode de connexió">
          <button class="mode-btn ${this.mode==="local"?"active":""}" data-mode="local">
            ${c("lobby.mode_local")}
          </button>
          <button class="mode-btn ${this.mode==="online"?"active":""}" data-mode="online">
            ${c("lobby.mode_online")}
          </button>
        </div>

        ${this.mode==="online"?`
          <p class="lobby-mode-hint">${c("lobby.mode_online_hint")}</p>
        `:`
          <p class="lobby-mode-hint">${c("lobby.mode_local_hint")}</p>
        `}

        <div class="lobby-actions">
          <button class="btn btn-primary" id="btn-create">${c("lobby.create")}</button>
          <div class="lobby-divider">o</div>
          <div class="join-form">
            <input class="input" id="input-code" type="text"
                   placeholder="${c("lobby.room_code")}"
                   maxlength="7" autocomplete="off" spellcheck="false" />
            <input class="input input-name" id="input-name" type="text"
                   placeholder="${c("lobby.your_name")}"
                   maxlength="20" autocomplete="off" />
            <button class="btn btn-secondary" id="btn-join">${c("lobby.join_btn")}</button>
          </div>
        </div>

        <p class="lobby-error" id="lobby-error" hidden></p>
      </section>
    `,this.bindMain()}bindMain(){this.container.querySelectorAll(".mode-btn").forEach(t=>{t.addEventListener("click",()=>{this.mode=t.getAttribute("data-mode"),this.renderMain()})}),this.container.querySelector("#btn-create").addEventListener("click",()=>{this.handleCreate()}),this.container.querySelector("#btn-join").addEventListener("click",()=>{const t=this.container.querySelector("#input-code").value.trim().toUpperCase(),n=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(t,n)});const e=this.container.querySelector("#input-code");e.addEventListener("input",()=>{const t=e.value.replace(/[^A-Za-z0-9]/g,"").toUpperCase().slice(0,6);e.value=t.length>3?`${t.slice(0,3)}-${t.slice(3)}`:t}),this.container.querySelector("#input-code").addEventListener("keydown",t=>{if(t.key==="Enter"){const n=this.container.querySelector("#input-code").value.trim().toUpperCase(),o=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(n,o)}})}async handleCreate(){this.setLoading(!0);const e=this.createRelay();try{await e.connect()}catch{this.showError(c("error.connection"));return}e.on(p.ROOM_CREATED,t=>{const{roomCode:n,clientId:o}=t.payload;e.roomCode=n,e.clientId=o,this.onJoined(e,n,o,!0)}),e.on(p.RELAY_ERROR,t=>{const{message:n}=t.payload;this.showError(n)}),e.createRoom()}async handleJoin(e,t){if(!e||e.length<5){this.showError(c("error.room_not_found"));return}this.setLoading(!0);const n=this.createRelay();try{await n.connect()}catch{this.showError(c("error.connection"));return}n.on(p.ROOM_JOINED,o=>{const{roomCode:i,clientId:r}=o.payload;n.roomCode=i,n.clientId=r,this.onJoined(n,i,r,!1)}),n.on(p.RELAY_ERROR,o=>{const{message:i}=o.payload;this.showError(i)}),n.joinRoom(e,t)}createRelay(){return this.mode==="local"?new Ee:new Ie(this.relayUrl)}setLoading(e){const t=this.container.querySelector("#btn-create"),n=this.container.querySelector("#btn-join");t&&(t.disabled=e),n&&(n.disabled=e)}showError(e){this.renderMain();const t=this.container.querySelector("#lobby-error");t&&(t.hidden=!1,t.textContent=e)}}class Me{container;config;onChange;constructor(e,t){this.container=e,this.config={...Q},this.onChange=t,this.render()}render(){this.container.innerHTML=`
      <details class="config-panel" open>
        <summary>${c("config.title")}</summary>
        <div class="config-grid">
          ${this.field("number","roundDuration",c("config.round_duration"),5,30)}
          ${this.field("number","maxRounds",c("config.max_rounds"),0,999)}
          ${this.field("number","baseProduction",c("config.base_production"),1,10)}
          ${this.field("number","productionPerNeighbor",c("config.production_per_neighbor"),0,5)}
          ${this.field("number","bonusAfterRounds",c("config.bonus_after_rounds"),1,20)}
          ${this.field("number","bonusTroops",c("config.bonus_troops"),0,20)}
          ${this.field("number","defenseAdvantage",c("config.defense_advantage"),0,1,.05)}
          ${this.victorySelect()}
          ${this.field("number","victoryParam",c("config.victory_param"),1,100)}
          ${this.placementSelect()}
          ${this.field("number","startRegions",c("config.start_regions"),1,5)}
          ${this.visibilitySelect()}
        </div>
      </details>
    `,this.bindEvents(),this.fillValues()}field(e,t,n,o,i,r){const a=o!==void 0?`min="${o}"`:"",l=i!==void 0?`max="${i}"`:"",u=r!==void 0?`step="${r}"`:"";return`
      <label class="config-field">
        <span>${n}</span>
        <input type="${e}" data-key="${t}" ${a} ${l} ${u} />
      </label>
    `}victorySelect(){const e=[["total_conquest",c("config.victory_total")],["score_rounds",c("config.victory_score")],["map_percent",c("config.victory_percent")],["hill_control",c("config.victory_hill")]];return`
      <label class="config-field">
        <span>${c("config.victory_condition")}</span>
        <select data-key="victoryCondition">
          ${e.map(([t,n])=>`<option value="${t}">${n}</option>`).join("")}
        </select>
      </label>
    `}placementSelect(){return`
      <label class="config-field">
        <span>${c("config.start_placement")}</span>
        <select data-key="startPlacement">
          <option value="random">${c("config.placement_random")}</option>
          <option value="clustered">${c("config.placement_clustered")}</option>
        </select>
      </label>
    `}visibilitySelect(){const e=[["full",c("config.visibility_full")],["fog_of_war",c("config.visibility_fog_of_war")],["fog_strict",c("config.visibility_fog_strict")]];return`
      <label class="config-field">
        <span>${c("config.visibility_mode")}</span>
        <select data-key="visibilityMode">
          ${e.map(([t,n])=>`<option value="${t}">${n}</option>`).join("")}
        </select>
      </label>
    `}fillValues(){this.container.querySelectorAll("[data-key]").forEach(t=>{const n=t.getAttribute("data-key");t.value=String(this.config[n]??"")})}bindEvents(){this.container.querySelectorAll("[data-key]").forEach(t=>{t.addEventListener("change",()=>{const n=t.getAttribute("data-key"),o=t.value;if(t.tagName==="INPUT"&&t.type==="number"){const i=parseFloat(o);isNaN(i)||(this.config[n]=i)}else this.config[n]=o;this.onChange({...this.config})})})}getConfig(){return{...this.config}}}class Se{container;constructor(e){this.container=e}show(e,t,n,o,i){const r=t.find(u=>u.id===e),a=new Map;for(const u of n)u.ownerId&&a.set(u.ownerId,(a.get(u.ownerId)??0)+1);const l=[...t].sort((u,d)=>(a.get(d.id)??0)-(a.get(u.id)??0));this.container.innerHTML=`
      <section class="end-screen">
        <div class="end-winner" style="color: ${r?.color??"#fff"}">
          <span class="end-winner-label">${c("end.winner")}</span>
          <span class="end-winner-name">${N(r?.name??"?")}</span>
        </div>

        <table class="end-ranking" aria-label="${c("end.ranking")}">
          <thead><tr><th>#</th><th>${c("end.ranking")}</th><th>${c("end.regions")}</th></tr></thead>
          <tbody>
            ${l.map((u,d)=>`
              <tr class="${u.isEliminated?"eliminated":""}">
                <td>${d+1}</td>
                <td>
                  <span class="score-dot" style="background:${u.color}"></span>
                  ${N(u.name)}
                </td>
                <td>${a.get(u.id)??0}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="end-actions">
          <button class="btn btn-primary" id="btn-play-again">${c("end.play_again")}</button>
          <button class="btn btn-secondary" id="btn-new-room">${c("end.new_room")}</button>
        </div>
      </section>
    `,this.container.querySelector("#btn-play-again").addEventListener("click",o),this.container.querySelector("#btn-new-room").addEventListener("click",i)}}function N(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function F(s,e){return(Math.abs(s.q-e.q)+Math.abs(s.q+s.r-e.q-e.r)+Math.abs(s.r-e.r))/2}const Te=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function xe(s){return Te.map(e=>({q:s.q+e.q,r:s.r+e.r}))}function x(s){return`${s.q},${s.r}`}function Le(s,e,t=5){const n=Ae(t),o=new Map(n.map(l=>[x(l),l])),i=new Map,r=n.map((l,u)=>{const d={id:`r${u}`,coord:l,ownerId:null,troops:0,neighbors:[]};return i.set(x(l),d),d});for(const l of r)l.neighbors=xe(l.coord).filter(u=>o.has(x(u))).map(u=>i.get(x(u)).id);const a=Math.max(1,e.startRegions??1);return e.startPlacement==="random"?Pe(r,s,a):$e(r,s,a),r}function Ae(s){const e=[];for(let t=-s;t<=s;t++)for(let n=Math.max(-s,-t-s);n<=Math.min(s,-t+s);n++)e.push({q:t,r:n});return e}function D(s){const e=[...s];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Pe(s,e,t){const n=D(s);for(let o=0;o<e.length&&o<n.length;o++)n[o].ownerId=e[o],n[o].troops=3;t>1&&ee(s,e,t-1)}function $e(s,e,t){const n=s.filter(i=>F(i.coord,{q:0,r:0})>=Math.floor(Math.max(...s.map(r=>F(r.coord,{q:0,r:0})))*.6)),o=D(n).slice(0,e.length);for(let i=0;i<e.length;i++)o[i]&&(o[i].ownerId=e[i],o[i].troops=3);t>1&&ee(s,e,t-1)}function ee(s,e,t){const n=new Map(s.map(o=>[o.id,o]));for(let o=0;o<t;o++)for(const i of D([...e])){const r=[],a=new Set;for(const l of s)if(l.ownerId===i)for(const u of l.neighbors){if(a.has(u))continue;a.add(u);const d=n.get(u);d&&!d.ownerId&&r.push(d)}if(r.length>0){const l=r[Math.floor(Math.random()*r.length)];l.ownerId=i,l.troops=3}}}function Oe(s,e,t){const n=new Map(s.map(d=>[d.id,d])),o=new Map;for(const d of e)o.set(d.fromRegionId,(o.get(d.fromRegionId)??0)+d.troops);for(const[d,h]of o.entries()){const g=n.get(d);if(!g)continue;const m=Math.max(0,g.troops-1);if(h>m&&h>0){const y=m/h;for(const f of e)f.fromRegionId===d&&(f.troops=Math.max(0,Math.floor(f.troops*y)))}}const i=new Map,r=new Map;for(const d of e){const h=n.get(d.fromRegionId),g=n.get(d.toRegionId);if(!h||!g||!h.neighbors.includes(g.id))continue;const m=Math.min(d.troops,Math.max(0,h.troops-1));m<=0||(g.ownerId===d.playerId?(r.has(g.id)||r.set(g.id,[]),r.get(g.id).push({playerId:d.playerId,fromId:h.id,troops:m}),h.troops-=m):(i.has(g.id)||i.set(g.id,{toRegionId:g.id,attacks:[]}),i.get(g.id).attacks.push({playerId:d.playerId,fromRegionId:h.id,troops:m}),h.troops-=m))}const a=[],l=new Set;for(const[d,h]of i.entries()){const g=n.get(d),m=ke(g,h.attacks,t);g.ownerId=m.newOwnerId,g.troops=m.newTroops,a.push({regionId:d,newOwnerId:m.newOwnerId,newTroops:m.newTroops,attackers:h.attacks.map(y=>({playerId:y.playerId,troops:y.troops}))})}for(const[d,h]of r.entries()){const g=n.get(d);for(const y of h)g.troops+=y.troops;const m=a.find(y=>y.regionId===d);m?m.newTroops=g.troops:a.push({regionId:d,newOwnerId:g.ownerId,newTroops:g.troops,attackers:[]})}const u=new Set(s.map(d=>d.ownerId).filter(Boolean));for(const d of s)d.ownerId&&!u.has(d.ownerId)&&l.add(d.ownerId);return{round:0,regionDeltas:a,eliminated:[...l],winner:null}}function ke(s,e,t){const n=e.reduce((d,h)=>d+h.troops,0),o=s.troops;if(o===0)return{newOwnerId:e.reduce((h,g)=>h.troops>g.troops?h:g).playerId,newTroops:n};const i=t.defenseAdvantage,r=1-i,a=i,l=Math.round(n*r),u=Math.round(o*a);return l>u?{newOwnerId:e.reduce((h,g)=>h.troops>g.troops?h:g).playerId,newTroops:Math.max(1,l-u)}:{newOwnerId:s.ownerId,newTroops:Math.max(1,u-l)}}const j=new Map;function De(s,e,t=new Set){for(const n of s){if(!n.ownerId)continue;let o=e.baseProduction;const i=n.neighbors.filter(a=>s.find(u=>u.id===a)?.ownerId===n.ownerId);o+=i.length*e.productionPerNeighbor;const r=j.get(n.id);r&&r.ownerId===n.ownerId?(r.rounds++,r.rounds>=e.bonusAfterRounds&&(o+=e.bonusTroops)):j.set(n.id,{ownerId:n.ownerId,rounds:1}),!t.has(n.id)&&(n.troops+=o)}}function qe(s,e,t,n){const o=e.filter(i=>!i.isEliminated);if(o.length===0)return null;if(o.length===1)return o[0].id;switch(t.victoryCondition){case"total_conquest":return Be(s,o);case"score_rounds":return t.maxRounds&&n>=t.maxRounds?Ne(s,o):null;case"map_percent":{const i=t.victoryParam/100;return He(s,o,i)}case"hill_control":return Fe(s,o,t);default:return null}}function q(s){const e=new Map;for(const t of s)t.ownerId&&e.set(t.ownerId,(e.get(t.ownerId)??0)+1);return e}function Be(s,e){const t=q(s),n=s.length;for(const o of e)if((t.get(o.id)??0)===n)return o.id;return null}function He(s,e,t){const n=q(s),o=s.length;for(const i of e)if((n.get(i.id)??0)/o>=t)return i.id;return null}function Ne(s,e){const t=q(s);let n=null,o=-1;for(const i of e){const r=t.get(i.id)??0;r>o&&(o=r,n=i.id)}return n}const L=new Map;function Fe(s,e,t,n){const o=s.find(a=>a.coord.q===0&&a.coord.r===0);if(!o||!o.ownerId)return null;const i=o.ownerId,r=L.get(i)??0;L.set(i,r+1);for(const a of e)a.id!==i&&L.set(a.id,0);return(L.get(i)??0)>=t.victoryParam?i:null}class C{relay;players=new Map;regions=[];config={...Q};round=0;phase="lobby";roundTimer=null;pendingOrders=new Map;static PLAYER_COLORS=["#e05c5c","#5c9ee0","#5ce07a","#e0c45c","#c45ce0","#5ce0d4","#e08c5c","#a0e05c"];colorIndex=0;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(p.PLAYER_JOINED,e=>{const{id:t,name:n}=e.payload;if(this.players.has(t))return;const o=C.PLAYER_COLORS[this.colorIndex%C.PLAYER_COLORS.length];this.colorIndex++;const i={id:t,name:n,color:o,isAdmin:!1,isReady:!1,isEliminated:!1};this.players.set(t,i),this.broadcastState()}),this.relay.on(p.PLAYER_LEFT,e=>{const{id:t}=e.payload;this.players.delete(t),this.broadcastState()}),this.relay.on(p.PLAYER_READY,e=>{const t=this.players.get(e.from??"");t&&(t.isReady=!0,this.broadcastState())}),this.relay.on(p.PLAYER_ORDERS,e=>{const{orders:t}=e.payload;this.pendingOrders.set(e.from??"",t)})}updateConfig(e){this.config={...this.config,...e},this.broadcastState()}kickPlayer(e){this.players.has(e)&&(this.players.delete(e),this.relay.send(p.PLAYER_KICK,{id:e}),this.broadcastState())}renamePlayer(e,t){const n=this.players.get(e);n&&(n.name=t.trim().slice(0,20)||n.name,this.broadcastState())}startGame(){if(this.phase!=="lobby")return;const e=[...this.players.keys()],t={id:this.relay.clientId,name:"Admin",color:C.PLAYER_COLORS[this.colorIndex%C.PLAYER_COLORS.length],isAdmin:!0,isReady:!0,isEliminated:!1};this.players.set(t.id,t),e.unshift(t.id),this.regions=Le(e,this.config),this.startRound()}static RESOLVE_GRACE_MS=1e3;startRound(e=new Set){this.round++,this.phase="planning",this.pendingOrders.clear(),De(this.regions,this.config,e),this.broadcastState(),this.relay.send(p.ROUND_START,{round:this.round,duration:this.config.roundDuration}),this.roundTimer=setTimeout(()=>this.resolveRound(),this.config.roundDuration*1e3+C.RESOLVE_GRACE_MS)}resolveRound(){if(this.phase!=="planning")return;this.phase="resolving";const e=[...this.pendingOrders.entries()].flatMap(([r,a])=>a.map(l=>({...l,playerId:r}))),t=new Map(this.regions.map(r=>[r.id,r.ownerId])),n=Oe(this.regions,e,this.config);n.round=this.round;for(const r of n.regionDeltas){const a=this.regions.find(l=>l.id===r.regionId);a&&(a.ownerId=r.newOwnerId,a.troops=r.newTroops)}const o=new Set(this.regions.filter(r=>r.ownerId!==null&&r.ownerId!==t.get(r.id)).map(r=>r.id));for(const r of n.eliminated){const a=this.players.get(r);a&&(a.isEliminated=!0)}this.relay.send(p.ROUND_RESOLVE,n);const i=qe(this.regions,[...this.players.values()],this.config,this.round);if(i){this.phase="ended",this.relay.send(p.GAME_OVER,{winnerId:i,round:this.round});return}setTimeout(()=>this.startRound(o),2500)}broadcastState(){const e={players:[...this.players.values()],regions:this.regions,config:this.config,round:this.round,phase:this.phase};this.relay.send(p.GAME_STATE,e)}syncState(){this.broadcastState()}destroy(){this.roundTimer&&clearTimeout(this.roundTimer)}}class je{relay;players=[];regions=[];config=null;round=0;phase="lobby";winnerId=null;localOrders=[];listeners=new Map;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(p.GAME_STATE,e=>{const t=e.payload;this.players=t.players,this.regions=t.regions,this.config=t.config,this.round=t.round,this.phase=t.phase,this.emit("state:updated",t)}),this.relay.on(p.ROUND_START,e=>{const{round:t,duration:n}=e.payload;this.round=t,this.phase="planning",this.localOrders=[],this.emit("round:started",{round:t,duration:n})}),this.relay.on(p.ROUND_RESOLVE,e=>{const t=e.payload;this.phase="resolving",this.emit("round:resolved",t)}),this.relay.on(p.GAME_OVER,e=>{const{winnerId:t}=e.payload;this.winnerId=t,this.phase="ended",this.emit("game:over",{winnerId:t})})}addOrder(e){this.localOrders=this.localOrders.filter(t=>!(t.fromRegionId===e.fromRegionId&&t.toRegionId===e.toRegionId)),this.localOrders.push(e)}removeOrder(e,t){this.localOrders=this.localOrders.filter(n=>!(n.fromRegionId===e&&n.toRegionId===t)),this.relay.send(p.PLAYER_CANCEL,{fromRegionId:e,toRegionId:t})}submitOrders(){this.relay.send(p.PLAYER_ORDERS,{orders:this.localOrders})}setReady(){this.relay.send(p.PLAYER_READY,{})}regionById(e){return this.regions.find(t=>t.id===e)}playerById(e){return this.players.find(t=>t.id===e)}myId(){return this.relay.clientId}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(n=>n(t))}}class ze{state={x:0,y:0,scale:1};minScale;maxScale;zoomStep=.1;isPanning=!1;lastPanPoint={x:0,y:0};rightPanBlocked=!1;blockRightPan(e){this.rightPanBlocked=e}canvas;onChangeCallback=null;constructor(e,t){this.canvas=e,this.minScale=t?.minScale??.3,this.maxScale=t?.maxScale??4,this.attachEvents()}attachEvents(){this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detachEvents(){this.canvas.removeEventListener("wheel",this.onWheel),this.canvas.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onWheel=e=>{e.preventDefault();const t=e.deltaY>0?-this.zoomStep:this.zoomStep,n=this.canvas.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top;this.zoomAt(o,i,t)};onMouseDown=e=>{(e.button===1||e.button===2&&!this.rightPanBlocked)&&(this.isPanning=!0,this.lastPanPoint={x:e.clientX,y:e.clientY},this.canvas.style.cursor="grabbing",e.preventDefault())};onMouseMove=e=>{if(!this.isPanning)return;const t=e.clientX-this.lastPanPoint.x,n=e.clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.clientX,y:e.clientY},this.pan(t,n)};onMouseUp=e=>{(e.button===1||e.button===2)&&(this.isPanning=!1,this.canvas.style.cursor="")};lastTouchDist=0;onTouchStart=e=>{e.touches.length===2?(e.preventDefault(),this.lastTouchDist=z(e)):e.touches.length===1&&(this.isPanning=!0,this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY})};onTouchMove=e=>{if(e.touches.length===2){e.preventDefault();const t=z(e),n=Ye(e,this.canvas),o=(t-this.lastTouchDist)/this.lastTouchDist*.5;this.zoomAt(n.x,n.y,o),this.lastTouchDist=t}else if(e.touches.length===1&&this.isPanning){const t=e.touches[0].clientX-this.lastPanPoint.x,n=e.touches[0].clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.pan(t,n)}};onTouchEnd=()=>{this.isPanning=!1,this.lastTouchDist=0};zoomAt(e,t,n){const o=Math.min(this.maxScale,Math.max(this.minScale,this.state.scale+n));if(o===this.state.scale)return;const i=o/this.state.scale;this.state.x=e-i*(e-this.state.x),this.state.y=t-i*(t-this.state.y),this.state.scale=o,this.onChange()}zoomIn(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,this.zoomStep*2)}zoomOut(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,-this.zoomStep*2)}resetZoom(){this.state={x:0,y:0,scale:1},this.centerOnCanvas(),this.onChange()}pan(e,t){this.state.x+=e,this.state.y+=t,this.onChange()}centerOnCanvas(){this.state.x=this.canvas.width/2,this.state.y=this.canvas.height/2}applyToContext(e){e.setTransform(this.state.scale,0,0,this.state.scale,this.state.x,this.state.y)}canvasToWorld(e,t){return{x:(e-this.state.x)/this.state.scale,y:(t-this.state.y)/this.state.scale}}get currentScale(){return this.state.scale}get snapshot(){return{...this.state}}onChange(e){if(e){this.onChangeCallback=e;return}this.onChangeCallback?.()}}function z(s){const e=s.touches[0].clientX-s.touches[1].clientX,t=s.touches[0].clientY-s.touches[1].clientY;return Math.hypot(e,t)}function Ye(s,e){const t=e.getBoundingClientRect();return{x:(s.touches[0].clientX+s.touches[1].clientX)/2-t.left,y:(s.touches[0].clientY+s.touches[1].clientY)/2-t.top}}const $=48;function S(s,e,t=$){return{x:t*(3/2*s),y:t*(Math.sqrt(3)/2*s+Math.sqrt(3)*e)}}function Ue(s,e,t=$){const n=.6666666666666666*s/t,o=(-1/3*s+Math.sqrt(3)/3*e)/t;return We(n,o)}function We(s,e){const t=-s-e;let n=Math.round(s),o=Math.round(e);const i=Math.round(t),r=Math.abs(n-s),a=Math.abs(o-e),l=Math.abs(i-t);return r>a&&r>l?n=-o-i:a>l&&(o=-n-i),{q:n,r:o}}function Ve(s,e,t){return Array.from({length:6},(n,o)=>{const i=Math.PI/180*(60*o);return[s+t*Math.cos(i),e+t*Math.sin(i)]})}class Je{canvas;ctx;camera;selectedRegionId=null;highlightedRegionIds=new Set;deleteTargetRegionId=null;myPlayerId=null;config=null;ownerStreak=new Map;updateOwnerStreak(e){for(const t of e){if(!t.ownerId){this.ownerStreak.delete(t.id);continue}const n=this.ownerStreak.get(t.id);n&&n.ownerId===t.ownerId?n.rounds++:this.ownerStreak.set(t.id,{ownerId:t.ownerId,rounds:1})}}resetOwnerStreak(){this.ownerStreak.clear()}constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,{width:o,height:i}=this.canvas;n.clearRect(0,0,o,i),n.save(),this.camera.applyToContext(n);const r=new Map(t.map(a=>[a.id,a.color]));for(const a of e)this.drawRegion(n,a,r,e);n.restore()}drawRegion(e,t,n,o){const{x:i,y:r}=S(t.coord.q,t.coord.r),a=$-2,l=Ve(i,r,a);e.beginPath(),e.moveTo(l[0][0],l[0][1]);for(let h=1;h<6;h++)e.lineTo(l[h][0],l[h][1]);e.closePath();const u=t.id===this.selectedRegionId,d=this.highlightedRegionIds.has(t.id);if(t.ownerId){const h=n.get(t.ownerId)??"#888";e.fillStyle=u?Y(h,.3):d?Y(h,.15):h}else e.fillStyle=d?"rgba(200,200,200,0.4)":"rgba(120,120,120,0.3)";if(e.fill(),e.strokeStyle=u?"#fff":"rgba(0,0,0,0.4)",e.lineWidth=u?2.5:1.2,e.stroke(),t.id===this.deleteTargetRegionId&&(e.fillStyle="rgba(210, 45, 45, 0.35)",e.fill(),e.strokeStyle="rgba(210, 45, 45, 0.9)",e.lineWidth=2.5,e.stroke()),t.troops>0&&(e.fillStyle="#fff",e.font=`bold ${Math.max(11,$*.3)}px system-ui, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(t.troops),i,r)),t.ownerId&&t.ownerId===this.myPlayerId&&this.config){const h=(()=>{const w=this.ownerStreak.get(t.id);return w?.ownerId===t.ownerId?w.rounds:0})(),g=Xe(t,o,this.config,h),m=i-a*.44,y=r-a*.6,f=`+${g}`;e.font="bold 9px system-ui, sans-serif",e.textAlign="left",e.textBaseline="middle",e.shadowColor="rgba(0,0,0,0.7)",e.shadowBlur=3,e.fillStyle="rgba(255,255,255,0.90)",e.fillText(f,m,y),e.shadowBlur=0}}regionAt(e,t,n){const o=this.camera.canvasToWorld(e,t),{q:i,r}=Ue(o.x,o.y);return n.find(a=>a.coord.q===i&&a.coord.r===r)??null}resize(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight}}function Xe(s,e,t,n){const o=s.neighbors.filter(a=>e.find(u=>u.id===a)?.ownerId===s.ownerId),i=t.baseProduction+o.length*t.productionPerNeighbor,r=n>=t.bonusAfterRounds?t.bonusTroops:0;return i+r}function Y(s,e){const t=parseInt(s.slice(1),16),n=Math.min(255,(t>>16&255)+Math.round(255*e)),o=Math.min(255,(t>>8&255)+Math.round(255*e)),i=Math.min(255,(t&255)+Math.round(255*e));return`rgb(${n},${o},${i})`}class Ge{ctx;camera;constructor(e,t){this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,o=new Map(t.map(i=>[i.id,i]));n.save(),this.camera.applyToContext(n);for(const i of e){const r=o.get(i.fromRegionId),a=o.get(i.toRegionId);if(!r||!a)continue;const l=S(r.coord.q,r.coord.r),u=S(a.coord.q,a.coord.r);i.animated&&i.progress!==void 0?this.drawAnimatedArrow(n,l,u,i):this.drawPlanningArrow(n,l,u,i)}n.restore()}drawPlanningArrow(e,t,n,o){const i=U(o.color,.72);e.save(),e.setLineDash([6,4]),e.globalAlpha=.75,e.strokeStyle="rgba(0,0,0,0.6)",e.fillStyle="rgba(0,0,0,0.6)",e.lineWidth=5.5,A(e,t.x,t.y,n.x,n.y),e.globalAlpha=.92,e.strokeStyle=i,e.fillStyle=i,e.lineWidth=2.5,A(e,t.x,t.y,n.x,n.y);const r=(t.x+n.x)/2,a=(t.y+n.y)/2,l=String(o.troops);e.setLineDash([]),e.globalAlpha=1,e.font="bold 12px system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle";const d=e.measureText(l).width+12,h=20,g=r-d/2,m=a-h/2;e.fillStyle="rgba(16, 18, 26, 0.88)",W(e,g,m,d,h,5),e.fill(),e.strokeStyle=i,e.lineWidth=1.5,W(e,g,m,d,h,5),e.stroke(),e.fillStyle="#ffffff",e.fillText(l,r,a),e.restore()}drawAnimatedArrow(e,t,n,o){const i=o.progress??0,r=t.x+(n.x-t.x)*i,a=t.y+(n.y-t.y)*i;e.globalAlpha=1-i*.3,e.fillStyle=o.color,e.beginPath(),e.arc(r,a,7,0,Math.PI*2),e.fill(),e.globalAlpha=1}drawDeleteDragArrow(e,t,n){const o=this.ctx,i="rgba(210, 45, 45, 0.85)";o.save(),this.camera.applyToContext(o),o.setLineDash([5,4]),o.globalAlpha=.4,o.strokeStyle="rgba(0,0,0,0.55)",o.lineWidth=5,o.beginPath(),o.moveTo(e.x,e.y),o.lineTo(t.x,t.y),o.stroke(),o.globalAlpha=.8,o.strokeStyle=i,o.lineWidth=2,o.beginPath(),o.moveTo(e.x,e.y),o.lineTo(t.x,t.y),o.stroke(),o.setLineDash([]),o.globalAlpha=1,o.strokeStyle=i,o.lineWidth=2.5,n?(o.beginPath(),o.moveTo(t.x-9,t.y-9),o.lineTo(t.x+9,t.y+9),o.moveTo(t.x+9,t.y-9),o.lineTo(t.x-9,t.y+9),o.stroke()):(o.globalAlpha=.6,o.beginPath(),o.arc(t.x,t.y,5,0,Math.PI*2),o.stroke()),o.restore()}drawDragArrow(e,t,n){const o=this.ctx,i=U(n,.72);o.save(),this.camera.applyToContext(o),o.setLineDash([5,4]),o.globalAlpha=.5,o.strokeStyle="rgba(0,0,0,0.55)",o.fillStyle="rgba(0,0,0,0.55)",o.lineWidth=5,A(o,e.x,e.y,t.x,t.y),o.globalAlpha=.65,o.strokeStyle=i,o.fillStyle=i,o.lineWidth=2,A(o,e.x,e.y,t.x,t.y),o.restore()}}function U(s,e){const t=parseInt(s.slice(1,3),16),n=parseInt(s.slice(3,5),16),o=parseInt(s.slice(5,7),16);return`rgb(${Math.round(t*e)},${Math.round(n*e)},${Math.round(o*e)})`}function W(s,e,t,n,o,i){s.beginPath(),s.moveTo(e+i,t),s.lineTo(e+n-i,t),s.arcTo(e+n,t,e+n,t+i,i),s.lineTo(e+n,t+o-i),s.arcTo(e+n,t+o,e+n-i,t+o,i),s.lineTo(e+i,t+o),s.arcTo(e,t+o,e,t+o-i,i),s.lineTo(e,t+i),s.arcTo(e,t,e+i,t,i),s.closePath()}function A(s,e,t,n,o){const i=Math.atan2(o-t,n-e),r=12,a=n-Math.cos(i)*14,l=o-Math.sin(i)*14;s.beginPath(),s.moveTo(e,t),s.lineTo(a,l),s.stroke(),s.setLineDash([]),s.beginPath(),s.moveTo(n,o),s.lineTo(n-r*Math.cos(i-Math.PI/6),o-r*Math.sin(i-Math.PI/6)),s.lineTo(n-r*Math.cos(i+Math.PI/6),o-r*Math.sin(i+Math.PI/6)),s.closePath(),s.fill()}class Ze{container;timerEl;phaseEl;roundEl;scoreEl;zoomControls;countdownInterval=null;submitTimeout=null;constructor(e){this.container=e,this.container.innerHTML=this.template(),this.timerEl=e.querySelector(".hud-timer"),this.phaseEl=e.querySelector(".hud-phase"),this.roundEl=e.querySelector(".hud-round"),this.scoreEl=e.querySelector(".hud-score"),this.zoomControls=e.querySelector(".zoom-controls")}template(){return`
      <div class="hud-top">
        <span class="hud-round"></span>
        <span class="hud-phase"></span>
        <span class="hud-timer"></span>
      </div>
      <div class="hud-score"></div>
      <div class="zoom-controls" aria-label="${c("zoom.controls")}">
        <button class="zoom-btn" data-action="in"  aria-label="${c("zoom.in")}">+</button>
        <button class="zoom-btn" data-action="reset" aria-label="${c("zoom.reset")}">⊙</button>
        <button class="zoom-btn" data-action="out" aria-label="${c("zoom.out")}">−</button>
      </div>
    `}bindZoom(e){this.zoomControls.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(!n)return;const o=n.getAttribute("data-action");o==="in"?e.zoomIn():o==="out"?e.zoomOut():o==="reset"&&e.reset()})}updateRound(e){this.roundEl.textContent=`${c("hud.round")} ${e}`}updatePhase(e){const t={lobby:c("phase.lobby"),planning:c("phase.planning"),resolving:c("phase.resolving"),ended:c("phase.ended")};this.phaseEl.textContent=t[e]??e,this.phaseEl.dataset.phase=e}startCountdown(e,t){this.stopCountdown();let n=e;this.timerEl.textContent=String(n),this.countdownInterval=setInterval(()=>{n--,this.timerEl.textContent=String(Math.max(0,n)),n<=0&&(clearInterval(this.countdownInterval),this.countdownInterval=null)},1e3),t&&(this.submitTimeout=setTimeout(()=>{this.submitTimeout=null,t()},e*1e3))}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null),this.submitTimeout&&(clearTimeout(this.submitTimeout),this.submitTimeout=null)}updateScoreboard(e,t){const n=new Map;for(const i of t)i.ownerId&&n.set(i.ownerId,(n.get(i.ownerId)??0)+1);const o=[...e].filter(i=>!i.isEliminated).sort((i,r)=>(n.get(r.id)??0)-(n.get(i.id)??0));this.scoreEl.innerHTML=o.map(i=>`
        <span class="score-entry">
          <span class="score-dot" style="background:${i.color}"></span>
          <span class="score-name">${Ke(i.name)}</span>
          <span class="score-count">${n.get(i.id)??0}</span>
        </span>
      `).join("")}}function Ke(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class Qe{canvas;hexRenderer;camera;myPlayerId;regions=[];orders=[];isDragging=!1;dragFrom=null;dragCurrentPixel=null;rightDragFrom=null;rightDownRegion=null;onOrderChange;onDragFrame=null;onRightDragFrame=null;onContextMenuCb=null;constructor(e,t,n,o,i){this.canvas=e,this.hexRenderer=t,this.camera=n,this.myPlayerId=o,this.onOrderChange=i,this.attachEvents()}updateState(e,t){this.regions=e,this.orders=t}onDrag(e){this.onDragFrame=e}onRightDrag(e){this.onRightDragFrame=e}onContextMenu(e){this.onContextMenuCb=e}attachEvents(){this.canvas.addEventListener("mousedown",this.onMouseDown,{capture:!0}),this.canvas.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("contextmenu",this.preventContextMenu),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detach(){this.canvas.removeEventListener("mousedown",this.onMouseDown,{capture:!0}),this.canvas.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("contextmenu",this.preventContextMenu),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onMouseDown=e=>{if(e.button===0){const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);if(!n||n.ownerId!==this.myPlayerId)return;this.isDragging=!0,this.dragFrom=n,this.dragCurrentPixel=t,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors)}else if(e.button===2){const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);this.rightDownRegion=n??null,n?.ownerId===this.myPlayerId&&(this.rightDragFrom=n,this.camera.blockRightPan(!0))}};onMouseMove=e=>{const t=this.canvasPos(e);if(this.isDragging&&this.dragFrom){this.dragCurrentPixel=t;const n=S(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)}if(this.rightDragFrom){const n=S(this.rightDragFrom.coord.q,this.rightDragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y),i=this.hexRenderer.regionAt(t.x,t.y,this.regions),r=i!==null&&i.id!==this.rightDragFrom.id&&this.rightDragFrom.neighbors.includes(i.id)&&this.orders.some(a=>a.fromRegionId===this.rightDragFrom.id&&a.toRegionId===i.id);this.onRightDragFrame?.(n,o,r?i.id:null)}};onMouseUp=e=>{if(e.button===0){if(!this.isDragging||!this.dragFrom)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&n.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(n.id)&&this.createOrUpdateOrder(this.dragFrom,n),this.endDrag()}else if(e.button===2){if(!this.rightDownRegion&&!this.rightDragFrom)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&this.rightDownRegion?.id===n.id?this.onContextMenuCb?.(n,e.clientX,e.clientY):this.rightDragFrom&&n&&n.id!==this.rightDragFrom.id&&this.removeOrder(this.rightDragFrom.id,n.id),this.rightDragFrom=null,this.rightDownRegion=null,this.camera.blockRightPan(!1),this.onRightDragFrame?.(null,null,null)}};preventContextMenu=e=>{e.preventDefault()};onTouchStart=e=>{if(e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);!n||n.ownerId!==this.myPlayerId||(this.isDragging=!0,this.dragFrom=n,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors))};onTouchMove=e=>{if(!this.isDragging||!this.dragFrom||e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]);this.dragCurrentPixel=t;const n=S(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)};onTouchEnd=e=>{if(!(!this.isDragging||!this.dragFrom)){if(this.dragCurrentPixel){const t=this.hexRenderer.regionAt(this.dragCurrentPixel.x,this.dragCurrentPixel.y,this.regions);t&&t.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(t.id)&&this.createOrUpdateOrder(this.dragFrom,t)}this.endDrag()}};createOrUpdateOrder(e,t){if(this.orders.find(a=>a.fromRegionId===e.id&&a.toRegionId===t.id))return;const o=this.orders.filter(a=>a.fromRegionId===e.id),i=Math.max(0,e.troops-1),r=Math.floor(i/(o.length+1));for(const a of o)a.troops=r;this.orders.push({fromRegionId:e.id,toRegionId:t.id,troops:r}),this.onOrderChange([...this.orders])}removeOrder(e,t){const n=this.orders.length;if(this.orders=this.orders.filter(i=>!(i.fromRegionId===e&&i.toRegionId===t)),this.orders.length===n)return;const o=this.orders.filter(i=>i.fromRegionId===e);if(o.length>0){const i=this.regions.find(r=>r.id===e);if(i){const r=Math.max(0,i.troops-1),a=Math.floor(r/o.length);for(const l of o)l.troops=a}}this.onOrderChange([...this.orders])}endDrag(){this.isDragging=!1,this.dragFrom=null,this.dragCurrentPixel=null,this.onDragFrame?.({x:0,y:0},{x:0,y:0}),this.hexRenderer.selectedRegionId=null,this.hexRenderer.highlightedRegionIds=new Set}canvasPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}touchPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}}const et={},tt=et?.VITE_RELAY_URL??"ws://localhost:3001";function P(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}console.log("[HexaTegy] main.ts carregat, iniciant bootstrap…");me();console.log("[HexaTegy] initI18n() completat");const te=document.getElementById("app-header"),T=document.getElementById("app-root"),ne=document.getElementById("version-history-modal");console.log("[HexaTegy] Elements DOM:",{headerEl:te,rootEl:T,versionModal:ne});const nt=new we(te,ne);console.log("[HexaTegy] AppHeader creat correctament");let O=null;function B(){console.log("[HexaTegy] showLobby() iniciant…"),O?.(),T.innerHTML="",new Ce(T,tt,(s,e,t,n)=>{O?.(),oe(s,e,t,n)}),console.log("[HexaTegy] LobbyView creat, esperant acció de l'usuari"),O=ge(()=>{nt.render(),B()})}function oe(s,e,t,n){T.innerHTML=`
    <section class="waiting-room">
      <div class="room-code-block">
        <span class="room-code-label">Sala</span>
        <strong class="room-code">${e}</strong>
      </div>
      <div class="waiting-room-cols">
        <div class="waiting-room-left">
          ${n?'<div id="config-panel-mount"></div>':'<div id="config-preview" class="config-preview"></div>'}
        </div>
        <div class="waiting-room-right">
          <div id="player-list" class="player-list">
            <p class="player-list-empty">${c("waiting.no_players")}</p>
          </div>
          ${n?`<button class="btn btn-primary" id="btn-start" disabled>${c("lobby.start_game")}</button>`:`<button class="btn btn-secondary" id="btn-ready">${c("lobby.ready")}</button>`}
        </div>
      </div>
    </section>
  `;let o=null,i=!1;function r(l){const u=document.getElementById("player-list");if(u){if(l.length===0){u.innerHTML=`<p class="player-list-empty">${c("waiting.no_players")}</p>`;return}u.innerHTML=l.map(d=>{const h=d.id===t,g=[d.isAdmin?'<span class="player-badge player-badge--admin">admin</span>':"",h?'<span class="player-badge player-badge--me">tu</span>':"",d.isReady?`<span class="player-badge player-badge--ready">${c("lobby.ready")}</span>`:""].join(""),m=n&&!h?`<button class="btn-icon-sm btn-edit-name" data-id="${d.id}" title="${c("waiting.edit_name")}">✎</button>`:"",y=n&&!h?`<button class="btn-icon-sm btn-kick" data-id="${d.id}" title="${c("waiting.kick")}">✕</button>`:"";return`
          <div class="player-item" data-id="${d.id}">
            <span class="player-dot" style="background:${d.color}"></span>
            <span class="player-name">${P(d.name)}</span>
            ${g}
            <span class="player-item-actions">${m}${y}</span>
          </div>`}).join(""),u.querySelectorAll(".btn-kick[data-id]").forEach(d=>{d.addEventListener("click",()=>o?.kickPlayer(d.dataset.id))}),u.querySelectorAll(".btn-edit-name[data-id]").forEach(d=>{d.addEventListener("click",()=>{const h=d.dataset.id,g=u.querySelector(`.player-item[data-id="${h}"]`);if(!g)return;const m=g.querySelector(".player-name");if(!m||g.querySelector(".player-name-input"))return;const y=m.textContent?.trim()??"",f=document.createElement("input");f.className="input player-name-input",f.value=y,f.maxLength=20,m.replaceWith(f),f.focus(),f.select();const w=()=>{const E=f.value.trim();E&&E!==y?o?.renamePlayer(h,E):f.replaceWith(m)};f.addEventListener("blur",w),f.addEventListener("keydown",E=>{E.key==="Enter"&&f.blur(),E.key==="Escape"&&(f.removeEventListener("blur",w),f.replaceWith(m))})})})}}function a(l){const u=document.getElementById("config-preview");if(!u)return;const d={full:c("config.visibility_full"),fog_of_war:c("config.visibility_fog_of_war"),fog_strict:c("config.visibility_fog_strict")},h={total_conquest:c("config.victory_total"),score_rounds:c("config.victory_score"),map_percent:c("config.victory_percent"),hill_control:c("config.victory_hill")},g={random:c("config.placement_random"),clustered:c("config.placement_clustered")},m=!l.maxRounds||l.maxRounds===0?c("waiting.max_rounds_unlimited"):String(l.maxRounds),y=[[c("config.visibility_mode"),d[l.visibilityMode]??l.visibilityMode],[c("config.victory_condition"),`${h[l.victoryCondition]??l.victoryCondition} (${l.victoryParam})`],[c("config.round_duration"),`${l.roundDuration}s`],[c("config.max_rounds"),m],[c("config.base_production"),`${l.baseProduction} + ${l.productionPerNeighbor}${c("waiting.per_neighbor")}`],[c("config.bonus_after_rounds"),`+${l.bonusTroops} ${c("waiting.from_round")} ${l.bonusAfterRounds}`],[c("config.defense_advantage"),`${Math.round(l.defenseAdvantage*100)}%`],[c("config.start_placement"),g[l.startPlacement]??l.startPlacement],[c("config.start_regions"),String(l.startRegions??1)]];u.innerHTML=`
      <h3 class="config-preview-title">${c("waiting.game_config")}</h3>
      <dl class="config-preview-grid">
        ${y.map(([f,w])=>`<dt>${P(f)}</dt><dd>${P(w)}</dd>`).join("")}
      </dl>
    `}if(n){o=new C(s);const l=document.getElementById("config-panel-mount");new Me(l,d=>o.updateConfig(d)),document.getElementById("btn-start").addEventListener("click",()=>o.startGame())}else{const l=document.getElementById("btn-ready");l.addEventListener("click",()=>{s.send(p.PLAYER_READY,{}),l.disabled=!0})}s.on(p.GAME_STATE,l=>{if(i)return;const u=l.payload;if(u.phase==="lobby"){if(r(u.players??[]),u.config&&a(u.config),n){const d=document.getElementById("btn-start");d&&(d.disabled=(u.players??[]).length<1)}}else(u.phase==="planning"||u.phase==="resolving")&&(i=!0,it(s,t,n,o))})}function ot(s,e,t){const n=t?.visibilityMode??"full";if(n==="full")return s;const o=new Set(s.filter(r=>r.ownerId===e).map(r=>r.id)),i=new Set;for(const r of o)s.find(l=>l.id===r)?.neighbors.forEach(l=>{o.has(l)||i.add(l)});return n==="fog_of_war"?s.map(r=>o.has(r.id)||i.has(r.id)?r:{...r,troops:0}):s.map(r=>o.has(r.id)||i.has(r.id)?r:{...r,ownerId:null,troops:0})}function it(s,e,t,n){T.innerHTML=`
    <div class="game-layout">
      <canvas id="game-canvas" class="game-canvas"></canvas>
      <div id="hud-overlay" class="hud-overlay"></div>
    </div>
  `;const o=document.getElementById("game-canvas"),i=document.getElementById("hud-overlay");function r(){o.width=o.offsetWidth,o.height=o.offsetHeight,R()}o.width=o.offsetWidth,o.height=o.offsetHeight,window.addEventListener("resize",r),o.addEventListener("contextmenu",b=>b.preventDefault());const a=new ze(o,{minScale:.25,maxScale:5});a.centerOnCanvas(),a.onChange(()=>R());const l=new Je(o,a);l.myPlayerId=e;const u=new Ge(o,a),d=new Ze(i),h=new je(s);t&&n&&n.syncState();let g=[],m=[],y=null,f=null;d.bindZoom({zoomIn:()=>a.zoomIn(),zoomOut:()=>a.zoomOut(),reset:()=>{a.resetZoom(),a.centerOnCanvas()}});const w=new Qe(o,l,a,e,b=>{g=b,h.localOrders=b,R()});w.onDrag((b,v)=>{const _=h.playerById(e);y=b.x!==0||v.x!==0?{from:b,to:v,color:_?.color??"#fff"}:null,R()}),w.onRightDrag((b,v,_)=>{!b||!v?(f=null,l.deleteTargetRegionId=null):(f={from:b,to:v,hasValidTarget:_!==null},l.deleteTargetRegionId=_),R()}),w.onContextMenu((b,v,_)=>{E(b,v,_)});function E(b,v,_){document.getElementById("region-ctx-menu")?.remove();const M=b.ownerId?h.playerById(b.ownerId):null,ie=M?.name??c("ctx.neutral"),se=M?.color??"var(--text-muted)",I=document.createElement("div");I.id="region-ctx-menu",I.className="region-ctx-menu";const re=172,ae=72,le=Math.min(v+4,window.innerWidth-re-8),ce=Math.min(_+4,window.innerHeight-ae-8);I.style.left=`${le}px`,I.style.top=`${ce}px`,I.innerHTML=`
      <div class="ctx-header">
        <span class="ctx-troops">⚔ ${b.troops}</span>
        <span class="ctx-owner" style="color:${se}">${P(ie)}</span>
      </div>
      <button class="ctx-item" disabled>${c("ctx.coming_soon")}</button>
    `,document.body.appendChild(I);const H=de=>{I.contains(de.target)||(I.remove(),document.removeEventListener("mousedown",H))};setTimeout(()=>document.addEventListener("mousedown",H),0)}function R(){const b=ot(h.regions,e,h.config);l.render(b,h.players);const v=h.playerById(e),_=g.map(M=>({fromRegionId:M.fromRegionId,toRegionId:M.toRegionId,troops:M.troops,color:v?.color??"#fff"}));u.render([..._,...m],h.regions),y&&u.drawDragArrow(y.from,y.to,y.color),f&&u.drawDeleteDragArrow(f.from,f.to,f.hasValidTarget)}h.on("state:updated",()=>{l.config=h.config,d.updateRound(h.round),d.updatePhase(h.phase),d.updateScoreboard(h.players,h.regions),w.updateState(h.regions,g),R()}),h.on("round:started",b=>{const{duration:v}=b;g=[],m=[],h.localOrders=[],l.updateOwnerStreak(h.regions),w.updateState(h.regions,g),d.startCountdown(v,()=>h.submitOrders()),R()}),h.on("round:resolved",()=>{d.stopCountdown(),setTimeout(()=>R(),2200)}),h.on("game:over",b=>{const{winnerId:v}=b;window.removeEventListener("resize",r),a.detachEvents(),w.detach(),st(s,v,h,n)}),R()}function st(s,e,t,n){new Se(T).show(e,t.players,t.regions,()=>oe(s,s.roomCode??"",s.clientId??"",n!==null),()=>{s.disconnect(),n?.destroy(),B()})}try{B()}catch(s){console.error("[HexaTegy] ERROR FATAL a showLobby():",s),document.getElementById("app-root").innerHTML=`<div style="padding:2rem;color:#e05c5c;font-family:monospace">
       <b>Error d'inicialització</b><br><pre>${String(s)}</pre>
       <p>Consulta la consola del navegador per més detalls.</p>
     </div>`}
