(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const z={"app.name":"HexaTegy","app.version_history":"Historial de versions","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En xarxa","lobby.mode_local_hint":"Juga en múltiples pestanyes al mateix navegador, sense servidor.","lobby.mode_online_hint":"Requereix el servidor relay actiu (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unir-se a sala","lobby.room_code":"Codi de sala","lobby.your_name":"El teu nom","lobby.join_btn":"Unir-se","lobby.create_btn":"Crear","lobby.connecting":"Connectant…","lobby.waiting":"Esperant jugadors…","lobby.players":"Jugadors","lobby.ready":"Llest","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparteix aquest codi","lobby.not_found":"Sala no trobada","config.title":"Configuració","config.round_duration":"Durada de ronda (s)","config.max_rounds":"Rondes màximes (0 = il·limitades)","config.base_production":"Producció base","config.production_per_neighbor":"Bonus per veí controlat","config.bonus_after_rounds":"Rondes per bonus continuat","config.bonus_troops":"Tropes de bonus","config.defense_advantage":"Avantatge defensor (0–1)","config.victory_condition":"Condició de victòria","config.victory_param":"Paràmetre de victòria","config.start_placement":"Col·locació inicial","config.placement_random":"Aleatòria","config.placement_clustered":"Agrupada","config.victory_total":"Conquesta total","config.victory_score":"Puntuació per rondes","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Desar configuració","phase.lobby":"Sala d'espera","phase.planning":"Planificació","phase.resolving":"Resolent…","phase.ended":"Partida acabada","hud.round":"Ronda","hud.submit_orders":"Confirmar ordres","hud.cancel_all":"Cancel·lar tot","zoom.controls":"Controls de zoom","zoom.in":"Apropar","zoom.out":"Allunyar","zoom.reset":"Reiniciar zoom","end.winner":"Guanyador","end.ranking":"Classificació","end.play_again":"Tornar a jugar","end.new_room":"Nova sala","end.regions":"regions","error.connection":"Error de connexió","error.room_not_found":"Sala no trobada","error.generic":"S'ha produït un error","version.title":"Historial de versions","version.close":"Tancar"},V={"app.name":"HexaTegy","app.version_history":"Historial de versiones","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"En red","lobby.mode_local_hint":"Juega en múltiples pestañas del mismo navegador, sin servidor.","lobby.mode_online_hint":"Requiere el servidor relay activo (ws://localhost:3001).","lobby.create":"Crear sala","lobby.join":"Unirse a sala","lobby.room_code":"Código de sala","lobby.your_name":"Tu nombre","lobby.join_btn":"Unirse","lobby.create_btn":"Crear","lobby.connecting":"Conectando…","lobby.waiting":"Esperando jugadores…","lobby.players":"Jugadores","lobby.ready":"Listo","lobby.start_game":"Iniciar partida","lobby.room_created":"Sala creada:","lobby.share_code":"Comparte este código","lobby.not_found":"Sala no encontrada","config.title":"Configuración","config.round_duration":"Duración de ronda (s)","config.max_rounds":"Rondas máximas (0 = ilimitadas)","config.base_production":"Producción base","config.production_per_neighbor":"Bonus por vecino controlado","config.bonus_after_rounds":"Rondas para bonus continuado","config.bonus_troops":"Tropas de bonus","config.defense_advantage":"Ventaja defensor (0–1)","config.victory_condition":"Condición de victoria","config.victory_param":"Parámetro de victoria","config.start_placement":"Colocación inicial","config.placement_random":"Aleatoria","config.placement_clustered":"Agrupada","config.victory_total":"Conquista total","config.victory_score":"Puntuación por rondas","config.victory_percent":"% del mapa","config.victory_hill":"Control de la colina","config.save":"Guardar configuración","phase.lobby":"Sala de espera","phase.planning":"Planificación","phase.resolving":"Resolviendo…","phase.ended":"Partida terminada","hud.round":"Ronda","hud.submit_orders":"Confirmar órdenes","hud.cancel_all":"Cancelar todo","zoom.controls":"Controles de zoom","zoom.in":"Acercar","zoom.out":"Alejar","zoom.reset":"Reiniciar zoom","end.winner":"Ganador","end.ranking":"Clasificación","end.play_again":"Volver a jugar","end.new_room":"Nueva sala","end.regions":"regiones","error.connection":"Error de conexión","error.room_not_found":"Sala no encontrada","error.generic":"Se ha producido un error","version.title":"Historial de versiones","version.close":"Cerrar"},W={"app.name":"HexaTegy","app.version_history":"Version history","lobby.title":"HexaTegy","lobby.mode_local":"Local","lobby.mode_online":"Online","lobby.mode_local_hint":"Play in multiple tabs in the same browser, no server needed.","lobby.mode_online_hint":"Requires the relay server running (ws://localhost:3001).","lobby.create":"Create room","lobby.join":"Join room","lobby.room_code":"Room code","lobby.your_name":"Your name","lobby.join_btn":"Join","lobby.create_btn":"Create","lobby.connecting":"Connecting…","lobby.waiting":"Waiting for players…","lobby.players":"Players","lobby.ready":"Ready","lobby.start_game":"Start game","lobby.room_created":"Room created:","lobby.share_code":"Share this code","lobby.not_found":"Room not found","config.title":"Settings","config.round_duration":"Round duration (s)","config.max_rounds":"Max rounds (0 = unlimited)","config.base_production":"Base production","config.production_per_neighbor":"Bonus per controlled neighbor","config.bonus_after_rounds":"Rounds for sustained bonus","config.bonus_troops":"Bonus troops","config.defense_advantage":"Defender advantage (0–1)","config.victory_condition":"Victory condition","config.victory_param":"Victory parameter","config.start_placement":"Starting placement","config.placement_random":"Random","config.placement_clustered":"Clustered","config.victory_total":"Total conquest","config.victory_score":"Score by rounds","config.victory_percent":"% of map","config.victory_hill":"Hill control","config.save":"Save settings","phase.lobby":"Lobby","phase.planning":"Planning","phase.resolving":"Resolving…","phase.ended":"Game over","hud.round":"Round","hud.submit_orders":"Submit orders","hud.cancel_all":"Cancel all","zoom.controls":"Zoom controls","zoom.in":"Zoom in","zoom.out":"Zoom out","zoom.reset":"Reset zoom","end.winner":"Winner","end.ranking":"Rankings","end.play_again":"Play again","end.new_room":"New room","end.regions":"regions","error.connection":"Connection error","error.room_not_found":"Room not found","error.generic":"An error occurred","version.title":"Version history","version.close":"Close"},Y={ca:z,es:V,en:W},B="hexategy_locale";let H=z,N="ca";const L=new Set;function G(i){return L.add(i),()=>L.delete(i)}function X(){const i=localStorage.getItem(B),e=navigator.language.slice(0,2).toLowerCase(),t=i??(Y[e]?e:"ca");j(t)}function j(i){const e=Y[i];e&&(H=e,N=i,localStorage.setItem(B,i),document.documentElement.setAttribute("lang",i),L.forEach(t=>t()))}function Z(){return N}function l(i){return H[i]??i}const K=[{code:"ca",label:"Català"},{code:"es",label:"Castellano"},{code:"en",label:"English"}],Q=[{version:"0.1.0",date:"2026-02-22",changes:["Esquelet inicial del projecte","Arquitectura Admin-as-Host via relay WebSocket","Sistema de coordenades hexagonals axials","Motor de combat i producció de tropes","Condicions de victòria configurables","Zoom i pan del canvas (roda, pinch, botons)","i18n: Català, Castellà, Anglès","Modo clar / fosc","Historial de versions"]}];class ee{modal;isOpen=!1;constructor(e){this.modal=e,this.modal.innerHTML=this.renderModal(),this.bindEvents()}renderModal(){const e=Q.map(t=>`
        <article class="version-entry">
          <header class="version-entry-header">
            <span class="version-tag">v${t.version}</span>
            <time class="version-date" datetime="${t.date}">${t.date}</time>
          </header>
          <ul class="version-changes">
            ${t.changes.map(n=>`<li>${te(n)}</li>`).join("")}
          </ul>
        </article>
      `).join("");return`
      <div class="modal-backdrop" data-action="close"></div>
      <div class="modal-dialog" role="dialog" aria-modal="true"
           aria-labelledby="version-modal-title">
        <header class="modal-header">
          <h2 id="version-modal-title">${l("version.title")}</h2>
          <button class="modal-close" data-action="close" aria-label="${l("version.close")}">✕</button>
        </header>
        <div class="modal-body version-list">
          ${e}
        </div>
      </div>
    `}bindEvents(){this.modal.addEventListener("click",e=>{e.target.closest("[data-action]")?.getAttribute("data-action")==="close"&&this.close()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isOpen&&this.close()})}open(){this.modal.hidden=!1,this.isOpen=!0,this.modal.querySelector(".modal-dialog")?.focus()}close(){this.modal.hidden=!0,this.isOpen=!1}toggle(){this.isOpen?this.close():this.open()}}function te(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class ne{container;versionHistory;theme;constructor(e,t){this.container=e,this.versionHistory=new ee(t),this.theme=localStorage.getItem("hexategy_theme")??"dark",document.documentElement.setAttribute("data-theme",this.theme),this.render(),this.container.addEventListener("click",this.handleClick),this.container.addEventListener("change",this.handleChange)}handleClick=e=>{const t=e.target.closest("button");t&&(t.classList.contains("version-btn")?this.versionHistory.toggle():t.classList.contains("theme-btn")&&this.toggleTheme())};handleChange=e=>{const t=e.target;t.classList.contains("locale-select")&&(j(t.value),this.render())};render(){this.container.innerHTML=`
      <div class="header-left">
        <span class="app-name">${l("app.name")}</span>
        <button class="icon-btn version-btn"
                title="${l("app.version_history")}"
                aria-label="${l("app.version_history")}">?</button>
      </div>
      <div class="header-right">
        <select class="locale-select" aria-label="Idioma / Language">
          ${K.map(e=>`<option value="${e.code}" ${e.code===Z()?"selected":""}>${e.label}</option>`).join("")}
        </select>
        <button class="icon-btn theme-btn" title="Tema" aria-label="Canviar tema">
          ${this.theme==="dark"?"☀":"☾"}
        </button>
      </div>
    `}toggleTheme(){this.theme=this.theme==="dark"?"light":"dark",document.documentElement.setAttribute("data-theme",this.theme),localStorage.setItem("hexategy_theme",this.theme),this.render()}}const g={ROOM_CREATED:"room:created",ROOM_JOINED:"room:joined",RELAY_ERROR:"relay:error",ROOM_CREATE:"room:create",ROOM_JOIN:"room:join",GAME_STATE:"game:state",ROUND_START:"round:start",ROUND_RESOLVE:"round:resolve",GAME_OVER:"game:over",PLAYER_JOINED:"player:joined",PLAYER_LEFT:"player:left",PLAYER_READY:"player:ready",PLAYER_ORDERS:"player:orders",PLAYER_CANCEL:"player:cancel"},U={roundDuration:20,maxRounds:null,baseProduction:2,productionPerNeighbor:1,bonusAfterRounds:3,bonusTroops:3,defenseAdvantage:.55,victoryCondition:"total_conquest",victoryParam:100,startPlacement:"random"};function oe(){return Math.random().toString(36).slice(2,9)}function se(){return[Math.random().toString(36).slice(2,5).toUpperCase(),Math.random().toString(36).slice(2,5).toUpperCase()].join("-")}class ie{clientId=oe();roomCode=null;isAdmin=!1;handlers=new Map;toAdminCh=null;fromAdminCh=null;connect(){return Promise.resolve()}createRoom(){this.isAdmin=!0;const e=se();this.roomCode=e,this.toAdminCh=new BroadcastChannel(`hexategy:${e}:to-admin`),this.toAdminCh.onmessage=t=>this.handleIncomingAsAdmin(t.data),this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.dispatch({type:g.ROOM_CREATED,payload:{roomCode:e,clientId:this.clientId}})}joinRoom(e,t){this.isAdmin=!1,this.roomCode=e,this.fromAdminCh=new BroadcastChannel(`hexategy:${e}:from-admin`),this.fromAdminCh.onmessage=s=>this.dispatch(s.data);const n=new BroadcastChannel(`hexategy:${e}:to-${this.clientId}`);n.onmessage=s=>{this.dispatch(s.data),n.close()};const o=new BroadcastChannel(`hexategy:${e}:to-admin`);o.postMessage({type:g.ROOM_JOIN,from:this.clientId,payload:{roomCode:e,name:t,clientId:this.clientId}}),o.close()}send(e,t={}){const n={type:e,from:this.clientId,payload:t};if(this.isAdmin)this.fromAdminCh?.postMessage(n),this.dispatch(n);else{if(!this.roomCode)return;const o=new BroadcastChannel(`hexategy:${this.roomCode}:to-admin`);o.postMessage(n),o.close()}}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}disconnect(){this.toAdminCh?.close(),this.fromAdminCh?.close()}handleIncomingAsAdmin(e){if(e.type===g.ROOM_JOIN){const{name:t,clientId:n}=e.payload,o=new BroadcastChannel(`hexategy:${this.roomCode}:to-${n}`);o.postMessage({type:g.ROOM_JOINED,payload:{roomCode:this.roomCode,clientId:n}}),o.close();const s={type:g.PLAYER_JOINED,payload:{id:n,name:t}};this.fromAdminCh?.postMessage(s),this.dispatch(s);return}this.dispatch(e)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}}class re{ws=null;handlers=new Map;reconnectTimer=null;url;clientId=null;roomCode=null;constructor(e){this.url=e}connect(){return new Promise((e,t)=>{this.ws=new WebSocket(this.url),this.ws.onopen=()=>e(),this.ws.onmessage=n=>{let o;try{o=JSON.parse(n.data)}catch{return}this.dispatch(o)},this.ws.onerror=()=>t(new Error("No s'ha pogut connectar al relay")),this.ws.onclose=()=>{this.dispatch({type:g.RELAY_ERROR,payload:{message:"Connexió tancada"}})}})}send(e,t={}){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("[relay-client] WebSocket no disponible");return}this.ws.send(JSON.stringify({type:e,payload:t}))}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>this.handlers.get(e)?.delete(t)}dispatch(e){this.handlers.get(e.type)?.forEach(t=>t(e)),this.handlers.get("*")?.forEach(t=>t(e))}createRoom(){this.send(g.ROOM_CREATE)}joinRoom(e,t){this.send(g.ROOM_JOIN,{roomCode:e,name:t})}disconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.ws?.close(),this.ws=null}}class ae{container;relayUrl;onJoined;mode="local";constructor(e,t,n){this.container=e,this.relayUrl=t,this.onJoined=n,this.renderMain()}renderMain(){this.container.innerHTML=`
      <section class="lobby-screen">
        <h1 class="lobby-logo">${l("lobby.title")}</h1>

        <div class="lobby-mode-toggle" role="group" aria-label="Mode de connexió">
          <button class="mode-btn ${this.mode==="local"?"active":""}" data-mode="local">
            ${l("lobby.mode_local")}
          </button>
          <button class="mode-btn ${this.mode==="online"?"active":""}" data-mode="online">
            ${l("lobby.mode_online")}
          </button>
        </div>

        ${this.mode==="online"?`
          <p class="lobby-mode-hint">${l("lobby.mode_online_hint")}</p>
        `:`
          <p class="lobby-mode-hint">${l("lobby.mode_local_hint")}</p>
        `}

        <div class="lobby-actions">
          <button class="btn btn-primary" id="btn-create">${l("lobby.create")}</button>
          <div class="lobby-divider">o</div>
          <div class="join-form">
            <input class="input" id="input-code" type="text"
                   placeholder="${l("lobby.room_code")}"
                   maxlength="7" autocomplete="off" spellcheck="false" />
            <input class="input input-name" id="input-name" type="text"
                   placeholder="${l("lobby.your_name")}"
                   maxlength="20" autocomplete="off" />
            <button class="btn btn-secondary" id="btn-join">${l("lobby.join_btn")}</button>
          </div>
        </div>

        <p class="lobby-error" id="lobby-error" hidden></p>
      </section>
    `,this.bindMain()}bindMain(){this.container.querySelectorAll(".mode-btn").forEach(e=>{e.addEventListener("click",()=>{this.mode=e.getAttribute("data-mode"),this.renderMain()})}),this.container.querySelector("#btn-create").addEventListener("click",()=>{this.handleCreate()}),this.container.querySelector("#btn-join").addEventListener("click",()=>{const e=this.container.querySelector("#input-code").value.trim().toUpperCase(),t=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(e,t)}),this.container.querySelector("#input-code").addEventListener("keydown",e=>{if(e.key==="Enter"){const t=this.container.querySelector("#input-code").value.trim().toUpperCase(),n=this.container.querySelector("#input-name").value.trim()||"Jugador";this.handleJoin(t,n)}})}async handleCreate(){this.setLoading(!0);const e=this.createRelay();try{await e.connect()}catch{this.showError(l("error.connection"));return}e.on(g.ROOM_CREATED,t=>{const{roomCode:n,clientId:o}=t.payload;e.roomCode=n,e.clientId=o,this.onJoined(e,n,o,!0)}),e.on(g.RELAY_ERROR,t=>{const{message:n}=t.payload;this.showError(n)}),e.createRoom()}async handleJoin(e,t){if(!e||e.length<5){this.showError(l("error.room_not_found"));return}this.setLoading(!0);const n=this.createRelay();try{await n.connect()}catch{this.showError(l("error.connection"));return}n.on(g.ROOM_JOINED,o=>{const{roomCode:s,clientId:a}=o.payload;n.roomCode=s,n.clientId=a,this.onJoined(n,s,a,!1)}),n.on(g.RELAY_ERROR,o=>{const{message:s}=o.payload;this.showError(s)}),n.joinRoom(e,t)}createRelay(){return this.mode==="local"?new ie:new re(this.relayUrl)}setLoading(e){const t=this.container.querySelector("#btn-create"),n=this.container.querySelector("#btn-join");t&&(t.disabled=e),n&&(n.disabled=e)}showError(e){this.renderMain();const t=this.container.querySelector("#lobby-error");t&&(t.hidden=!1,t.textContent=e)}}class ce{container;config;onChange;constructor(e,t){this.container=e,this.config={...U},this.onChange=t,this.render()}render(){this.container.innerHTML=`
      <details class="config-panel">
        <summary>${l("config.title")}</summary>
        <div class="config-grid">
          ${this.field("number","roundDuration",l("config.round_duration"),5,30)}
          ${this.field("number","maxRounds",l("config.max_rounds"),0,999)}
          ${this.field("number","baseProduction",l("config.base_production"),1,10)}
          ${this.field("number","productionPerNeighbor",l("config.production_per_neighbor"),0,5)}
          ${this.field("number","bonusAfterRounds",l("config.bonus_after_rounds"),1,20)}
          ${this.field("number","bonusTroops",l("config.bonus_troops"),0,20)}
          ${this.field("number","defenseAdvantage",l("config.defense_advantage"),0,1,.05)}
          ${this.victorySelect()}
          ${this.field("number","victoryParam",l("config.victory_param"),1,100)}
          ${this.placementSelect()}
        </div>
        <button class="btn btn-secondary config-save">${l("config.save")}</button>
      </details>
    `,this.bindEvents(),this.fillValues()}field(e,t,n,o,s,a){const r=o!==void 0?`min="${o}"`:"",u=s!==void 0?`max="${s}"`:"",c=a!==void 0?`step="${a}"`:"";return`
      <label class="config-field">
        <span>${n}</span>
        <input type="${e}" data-key="${t}" ${r} ${u} ${c} />
      </label>
    `}victorySelect(){const e=[["total_conquest",l("config.victory_total")],["score_rounds",l("config.victory_score")],["map_percent",l("config.victory_percent")],["hill_control",l("config.victory_hill")]];return`
      <label class="config-field">
        <span>${l("config.victory_condition")}</span>
        <select data-key="victoryCondition">
          ${e.map(([t,n])=>`<option value="${t}">${n}</option>`).join("")}
        </select>
      </label>
    `}placementSelect(){return`
      <label class="config-field">
        <span>${l("config.start_placement")}</span>
        <select data-key="startPlacement">
          <option value="random">${l("config.placement_random")}</option>
          <option value="clustered">${l("config.placement_clustered")}</option>
        </select>
      </label>
    `}fillValues(){this.container.querySelectorAll("[data-key]").forEach(t=>{const n=t.getAttribute("data-key");t.value=String(this.config[n]??"")})}bindEvents(){this.container.querySelector(".config-save").addEventListener("click",()=>{this.container.querySelectorAll("[data-key]").forEach(t=>{const n=t.getAttribute("data-key"),o=t.value;t.tagName==="INPUT"&&t.type==="number"?this.config[n]=parseFloat(o):this.config[n]=o}),this.onChange({...this.config})})}getConfig(){return{...this.config}}}class le{container;constructor(e){this.container=e}show(e,t,n,o,s){const a=t.find(c=>c.id===e),r=new Map;for(const c of n)c.ownerId&&r.set(c.ownerId,(r.get(c.ownerId)??0)+1);const u=[...t].sort((c,h)=>(r.get(h.id)??0)-(r.get(c.id)??0));this.container.innerHTML=`
      <section class="end-screen">
        <div class="end-winner" style="color: ${a?.color??"#fff"}">
          <span class="end-winner-label">${l("end.winner")}</span>
          <span class="end-winner-name">${P(a?.name??"?")}</span>
        </div>

        <table class="end-ranking" aria-label="${l("end.ranking")}">
          <thead><tr><th>#</th><th>${l("end.ranking")}</th><th>${l("end.regions")}</th></tr></thead>
          <tbody>
            ${u.map((c,h)=>`
              <tr class="${c.isEliminated?"eliminated":""}">
                <td>${h+1}</td>
                <td>
                  <span class="score-dot" style="background:${c.color}"></span>
                  ${P(c.name)}
                </td>
                <td>${r.get(c.id)??0}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="end-actions">
          <button class="btn btn-primary" id="btn-play-again">${l("end.play_again")}</button>
          <button class="btn btn-secondary" id="btn-new-room">${l("end.new_room")}</button>
        </div>
      </section>
    `,this.container.querySelector("#btn-play-again").addEventListener("click",o),this.container.querySelector("#btn-new-room").addEventListener("click",s)}}function P(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function T(i,e){return(Math.abs(i.q-e.q)+Math.abs(i.q+i.r-e.q-e.r)+Math.abs(i.r-e.r))/2}const de=[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}];function he(i){return de.map(e=>({q:i.q+e.q,r:i.r+e.r}))}function C(i){return`${i.q},${i.r}`}function ue(i,e,t=5){const n=ge(t),o=new Map(n.map(r=>[C(r),r])),s=new Map,a=n.map((r,u)=>{const c={id:`r${u}`,coord:r,ownerId:null,troops:0,neighbors:[]};return s.set(C(r),c),c});for(const r of a)r.neighbors=he(r.coord).filter(u=>o.has(C(u))).map(u=>s.get(C(u)).id);return e.startPlacement==="random"?me(a,i):pe(a,i),a}function ge(i){const e=[];for(let t=-i;t<=i;t++)for(let n=Math.max(-i,-t-i);n<=Math.min(i,-t+i);n++)e.push({q:t,r:n});return e}function F(i){const e=[...i];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function me(i,e){const t=F(i);for(let n=0;n<e.length&&n<t.length;n++)t[n].ownerId=e[n],t[n].troops=3}function pe(i,e){const t=i.filter(o=>T(o.coord,{q:0,r:0})>=Math.floor(Math.max(...i.map(s=>T(s.coord,{q:0,r:0})))*.6)),n=F(t).slice(0,e.length);for(let o=0;o<e.length;o++)n[o]&&(n[o].ownerId=e[o],n[o].troops=3)}function fe(i,e,t){const n=new Map(i.map(c=>[c.id,c])),o=new Map,s=new Map;for(const c of e){const h=n.get(c.fromRegionId),d=n.get(c.toRegionId);if(!h||!d||!h.neighbors.includes(d.id))continue;const m=Math.min(c.troops,Math.max(0,h.troops-1));m<=0||(d.ownerId===c.playerId?(s.has(d.id)||s.set(d.id,[]),s.get(d.id).push({playerId:c.playerId,fromId:h.id,troops:m}),h.troops-=m):(o.has(d.id)||o.set(d.id,{toRegionId:d.id,attacks:[]}),o.get(d.id).attacks.push({playerId:c.playerId,fromRegionId:h.id,troops:m}),h.troops-=m))}const a=[],r=new Set;for(const[c,h]of o.entries()){const d=n.get(c),m=ye(d,h.attacks,t);d.ownerId=m.newOwnerId,d.troops=m.newTroops,a.push({regionId:c,newOwnerId:m.newOwnerId,newTroops:m.newTroops,attackers:h.attacks.map(f=>({playerId:f.playerId,troops:f.troops}))})}for(const[c,h]of s.entries()){const d=n.get(c);for(const f of h)d.troops+=f.troops;const m=a.find(f=>f.regionId===c);m?m.newTroops=d.troops:a.push({regionId:c,newOwnerId:d.ownerId,newTroops:d.troops,attackers:[]})}const u=new Set(i.map(c=>c.ownerId).filter(Boolean));for(const c of i)c.ownerId&&!u.has(c.ownerId)&&r.add(c.ownerId);return{round:0,regionDeltas:a,eliminated:[...r],winner:null}}function ye(i,e,t){const n=e.reduce((h,d)=>h+d.troops,0),o=i.troops,s=t.defenseAdvantage,a=1-s,r=s,u=Math.round(n*a),c=Math.round(o*r);return u>c?{newOwnerId:e.reduce((d,m)=>d.troops>m.troops?d:m).playerId,newTroops:Math.max(1,u-c)}:{newOwnerId:i.ownerId,newTroops:Math.max(1,c-u)}}const $=new Map;function be(i,e){for(const t of i){if(!t.ownerId)continue;let n=e.baseProduction;const o=t.neighbors.filter(a=>i.find(u=>u.id===a)?.ownerId===t.ownerId);n+=o.length*e.productionPerNeighbor;const s=$.get(t.id);s&&s.ownerId===t.ownerId?(s.rounds++,s.rounds>=e.bonusAfterRounds&&(n+=e.bonusTroops)):$.set(t.id,{ownerId:t.ownerId,rounds:1}),t.troops+=n}}function ve(i,e,t,n){const o=e.filter(s=>!s.isEliminated);if(o.length===0)return null;if(o.length===1)return o[0].id;switch(t.victoryCondition){case"total_conquest":return we(i,o);case"score_rounds":return t.maxRounds&&n>=t.maxRounds?Ee(i,o):null;case"map_percent":{const s=t.victoryParam/100;return _e(i,o,s)}case"hill_control":return Re(i,o,t);default:return null}}function O(i){const e=new Map;for(const t of i)t.ownerId&&e.set(t.ownerId,(e.get(t.ownerId)??0)+1);return e}function we(i,e){const t=O(i),n=i.length;for(const o of e)if((t.get(o.id)??0)===n)return o.id;return null}function _e(i,e,t){const n=O(i),o=i.length;for(const s of e)if((n.get(s.id)??0)/o>=t)return s.id;return null}function Ee(i,e){const t=O(i);let n=null,o=-1;for(const s of e){const a=t.get(s.id)??0;a>o&&(o=a,n=s.id)}return n}const I=new Map;function Re(i,e,t,n){const o=i.find(r=>r.coord.q===0&&r.coord.r===0);if(!o||!o.ownerId)return null;const s=o.ownerId,a=I.get(s)??0;I.set(s,a+1);for(const r of e)r.id!==s&&I.set(r.id,0);return(I.get(s)??0)>=t.victoryParam?s:null}class v{relay;players=new Map;regions=[];config={...U};round=0;phase="lobby";roundTimer=null;pendingOrders=new Map;static PLAYER_COLORS=["#e05c5c","#5c9ee0","#5ce07a","#e0c45c","#c45ce0","#5ce0d4","#e08c5c","#a0e05c"];colorIndex=0;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(g.PLAYER_JOINED,e=>{const{id:t,name:n}=e.payload;if(this.players.has(t))return;const o=v.PLAYER_COLORS[this.colorIndex%v.PLAYER_COLORS.length];this.colorIndex++;const s={id:t,name:n,color:o,isAdmin:!1,isReady:!1,isEliminated:!1};this.players.set(t,s),this.broadcastState()}),this.relay.on(g.PLAYER_LEFT,e=>{const{id:t}=e.payload;this.players.delete(t),this.broadcastState()}),this.relay.on(g.PLAYER_READY,e=>{const t=this.players.get(e.from??"");t&&(t.isReady=!0,this.broadcastState())}),this.relay.on(g.PLAYER_ORDERS,e=>{const{orders:t}=e.payload;this.pendingOrders.set(e.from??"",t)})}updateConfig(e){this.config={...this.config,...e}}startGame(){if(this.phase!=="lobby")return;const e=[...this.players.keys()],t={id:this.relay.clientId,name:"Admin",color:v.PLAYER_COLORS[this.colorIndex%v.PLAYER_COLORS.length],isAdmin:!0,isReady:!0,isEliminated:!1};this.players.set(t.id,t),e.unshift(t.id),this.regions=ue(e,this.config),this.startRound()}startRound(){this.round++,this.phase="planning",this.pendingOrders.clear(),be(this.regions,this.config),this.broadcastState(),this.relay.send(g.ROUND_START,{round:this.round,duration:this.config.roundDuration}),this.roundTimer=setTimeout(()=>this.resolveRound(),this.config.roundDuration*1e3)}resolveRound(){if(this.phase!=="planning")return;this.phase="resolving";const e=[...this.pendingOrders.entries()].flatMap(([o,s])=>s.map(a=>({...a,playerId:o}))),t=fe(this.regions,e,this.config);t.round=this.round;for(const o of t.regionDeltas){const s=this.regions.find(a=>a.id===o.regionId);s&&(s.ownerId=o.newOwnerId,s.troops=o.newTroops)}for(const o of t.eliminated){const s=this.players.get(o);s&&(s.isEliminated=!0)}this.relay.send(g.ROUND_RESOLVE,t);const n=ve(this.regions,[...this.players.values()],this.config,this.round);if(n){this.phase="ended",this.relay.send(g.GAME_OVER,{winnerId:n,round:this.round});return}setTimeout(()=>this.startRound(),2500)}broadcastState(){const e={players:[...this.players.values()],regions:this.regions,config:this.config,round:this.round,phase:this.phase};this.relay.send(g.GAME_STATE,e)}syncState(){this.broadcastState()}destroy(){this.roundTimer&&clearTimeout(this.roundTimer)}}class Ce{relay;players=[];regions=[];config=null;round=0;phase="lobby";winnerId=null;localOrders=[];listeners=new Map;constructor(e){this.relay=e,this.setupListeners()}setupListeners(){this.relay.on(g.GAME_STATE,e=>{const t=e.payload;this.players=t.players,this.regions=t.regions,this.config=t.config,this.round=t.round,this.phase=t.phase,this.emit("state:updated",t)}),this.relay.on(g.ROUND_START,e=>{const{round:t,duration:n}=e.payload;this.round=t,this.phase="planning",this.localOrders=[],this.emit("round:started",{round:t,duration:n})}),this.relay.on(g.ROUND_RESOLVE,e=>{const t=e.payload;this.phase="resolving",this.emit("round:resolved",t)}),this.relay.on(g.GAME_OVER,e=>{const{winnerId:t}=e.payload;this.winnerId=t,this.phase="ended",this.emit("game:over",{winnerId:t})})}addOrder(e){this.localOrders=this.localOrders.filter(t=>!(t.fromRegionId===e.fromRegionId&&t.toRegionId===e.toRegionId)),this.localOrders.push(e)}removeOrder(e,t){this.localOrders=this.localOrders.filter(n=>!(n.fromRegionId===e&&n.toRegionId===t)),this.relay.send(g.PLAYER_CANCEL,{fromRegionId:e,toRegionId:t})}submitOrders(){this.relay.send(g.PLAYER_ORDERS,{orders:this.localOrders})}setReady(){this.relay.send(g.PLAYER_READY,{})}regionById(e){return this.regions.find(t=>t.id===e)}playerById(e){return this.players.find(t=>t.id===e)}myId(){return this.relay.clientId}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e)?.delete(t)}emit(e,t){this.listeners.get(e)?.forEach(n=>n(t))}}class Ie{state={x:0,y:0,scale:1};minScale;maxScale;zoomStep=.1;isPanning=!1;lastPanPoint={x:0,y:0};canvas;onChangeCallback=null;constructor(e,t){this.canvas=e,this.minScale=t?.minScale??.3,this.maxScale=t?.maxScale??4,this.attachEvents()}attachEvents(){this.canvas.addEventListener("wheel",this.onWheel,{passive:!1}),this.canvas.addEventListener("mousedown",this.onMouseDown),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detachEvents(){this.canvas.removeEventListener("wheel",this.onWheel),this.canvas.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onWheel=e=>{e.preventDefault();const t=e.deltaY>0?-this.zoomStep:this.zoomStep,n=this.canvas.getBoundingClientRect(),o=e.clientX-n.left,s=e.clientY-n.top;this.zoomAt(o,s,t)};onMouseDown=e=>{(e.button===1||e.button===2)&&(this.isPanning=!0,this.lastPanPoint={x:e.clientX,y:e.clientY},this.canvas.style.cursor="grabbing",e.preventDefault())};onMouseMove=e=>{if(!this.isPanning)return;const t=e.clientX-this.lastPanPoint.x,n=e.clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.clientX,y:e.clientY},this.pan(t,n)};onMouseUp=e=>{(e.button===1||e.button===2)&&(this.isPanning=!1,this.canvas.style.cursor="")};lastTouchDist=0;onTouchStart=e=>{e.touches.length===2?(e.preventDefault(),this.lastTouchDist=D(e)):e.touches.length===1&&(this.isPanning=!0,this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY})};onTouchMove=e=>{if(e.touches.length===2){e.preventDefault();const t=D(e),n=Me(e,this.canvas),o=(t-this.lastTouchDist)/this.lastTouchDist*.5;this.zoomAt(n.x,n.y,o),this.lastTouchDist=t}else if(e.touches.length===1&&this.isPanning){const t=e.touches[0].clientX-this.lastPanPoint.x,n=e.touches[0].clientY-this.lastPanPoint.y;this.lastPanPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.pan(t,n)}};onTouchEnd=()=>{this.isPanning=!1,this.lastTouchDist=0};zoomAt(e,t,n){const o=Math.min(this.maxScale,Math.max(this.minScale,this.state.scale+n));if(o===this.state.scale)return;const s=o/this.state.scale;this.state.x=e-s*(e-this.state.x),this.state.y=t-s*(t-this.state.y),this.state.scale=o,this.onChange()}zoomIn(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,this.zoomStep*2)}zoomOut(){const e=this.canvas.width/2,t=this.canvas.height/2;this.zoomAt(e,t,-this.zoomStep*2)}resetZoom(){this.state={x:0,y:0,scale:1},this.centerOnCanvas(),this.onChange()}pan(e,t){this.state.x+=e,this.state.y+=t,this.onChange()}centerOnCanvas(){this.state.x=this.canvas.width/2,this.state.y=this.canvas.height/2}applyToContext(e){e.setTransform(this.state.scale,0,0,this.state.scale,this.state.x,this.state.y)}canvasToWorld(e,t){return{x:(e-this.state.x)/this.state.scale,y:(t-this.state.y)/this.state.scale}}get currentScale(){return this.state.scale}get snapshot(){return{...this.state}}onChange(e){if(e){this.onChangeCallback=e;return}this.onChangeCallback?.()}}function D(i){const e=i.touches[0].clientX-i.touches[1].clientX,t=i.touches[0].clientY-i.touches[1].clientY;return Math.hypot(e,t)}function Me(i,e){const t=e.getBoundingClientRect();return{x:(i.touches[0].clientX+i.touches[1].clientX)/2-t.left,y:(i.touches[0].clientY+i.touches[1].clientY)/2-t.top}}const M=48;function E(i,e,t=M){return{x:t*(3/2*i),y:t*(Math.sqrt(3)/2*i+Math.sqrt(3)*e)}}function Se(i,e,t=M){const n=.6666666666666666*i/t,o=(-1/3*i+Math.sqrt(3)/3*e)/t;return Ae(n,o)}function Ae(i,e){const t=-i-e;let n=Math.round(i),o=Math.round(e);const s=Math.round(t),a=Math.abs(n-i),r=Math.abs(o-e),u=Math.abs(s-t);return a>r&&a>u?n=-o-s:r>u&&(o=-n-s),{q:n,r:o}}function Le(i,e,t){return Array.from({length:6},(n,o)=>{const s=Math.PI/180*(60*o);return[i+t*Math.cos(s),e+t*Math.sin(s)]})}class Oe{canvas;ctx;camera;selectedRegionId=null;highlightedRegionIds=new Set;constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,{width:o,height:s}=this.canvas;n.clearRect(0,0,o,s),n.save(),this.camera.applyToContext(n);const a=new Map(t.map(r=>[r.id,r.color]));for(const r of e)this.drawRegion(n,r,a);n.restore()}drawRegion(e,t,n){const{x:o,y:s}=E(t.coord.q,t.coord.r),a=M-2,r=Le(o,s,a);e.beginPath(),e.moveTo(r[0][0],r[0][1]);for(let h=1;h<6;h++)e.lineTo(r[h][0],r[h][1]);e.closePath();const u=t.id===this.selectedRegionId,c=this.highlightedRegionIds.has(t.id);if(t.ownerId){const h=n.get(t.ownerId)??"#888";e.fillStyle=u?k(h,.3):c?k(h,.15):h}else e.fillStyle=c?"rgba(200,200,200,0.4)":"rgba(120,120,120,0.3)";e.fill(),e.strokeStyle=u?"#fff":"rgba(0,0,0,0.4)",e.lineWidth=u?2.5:1.2,e.stroke(),t.troops>0&&(e.fillStyle="#fff",e.font=`bold ${Math.max(11,M*.3)}px system-ui, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(t.troops),o,s))}regionAt(e,t,n){const o=this.camera.canvasToWorld(e,t),{q:s,r:a}=Se(o.x,o.y);return n.find(r=>r.coord.q===s&&r.coord.r===a)??null}resize(){this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight}}function k(i,e){const t=parseInt(i.slice(1),16),n=Math.min(255,(t>>16&255)+Math.round(255*e)),o=Math.min(255,(t>>8&255)+Math.round(255*e)),s=Math.min(255,(t&255)+Math.round(255*e));return`rgb(${n},${o},${s})`}class xe{ctx;camera;constructor(e,t){this.ctx=e.getContext("2d"),this.camera=t}render(e,t){const n=this.ctx,o=new Map(t.map(s=>[s.id,s]));n.save(),this.camera.applyToContext(n);for(const s of e){const a=o.get(s.fromRegionId),r=o.get(s.toRegionId);if(!a||!r)continue;const u=E(a.coord.q,a.coord.r),c=E(r.coord.q,r.coord.r);s.animated&&s.progress!==void 0?this.drawAnimatedArrow(n,u,c,s):this.drawPlanningArrow(n,u,c,s)}n.restore()}drawPlanningArrow(e,t,n,o){const s=o.color;e.strokeStyle=s,e.fillStyle=s,e.lineWidth=2.5,e.globalAlpha=.85,e.setLineDash([6,4]),q(e,t.x,t.y,n.x,n.y);const a=(t.x+n.x)/2,r=(t.y+n.y)/2;e.setLineDash([]),e.globalAlpha=1,e.font="bold 12px system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(String(o.troops),a+2,r+2),e.fillStyle=s,e.fillText(String(o.troops),a,r)}drawAnimatedArrow(e,t,n,o){const s=o.progress??0,a=t.x+(n.x-t.x)*s,r=t.y+(n.y-t.y)*s;e.globalAlpha=1-s*.3,e.fillStyle=o.color,e.beginPath(),e.arc(a,r,7,0,Math.PI*2),e.fill(),e.globalAlpha=1}drawDragArrow(e,t,n){const o=this.ctx;o.save(),this.camera.applyToContext(o),o.strokeStyle=n,o.fillStyle=n,o.lineWidth=2,o.globalAlpha=.6,o.setLineDash([5,4]),q(o,e.x,e.y,t.x,t.y),o.restore()}}function q(i,e,t,n,o){const s=Math.atan2(o-t,n-e),a=12,r=n-Math.cos(s)*14,u=o-Math.sin(s)*14;i.beginPath(),i.moveTo(e,t),i.lineTo(r,u),i.stroke(),i.setLineDash([]),i.beginPath(),i.moveTo(n,o),i.lineTo(n-a*Math.cos(s-Math.PI/6),o-a*Math.sin(s-Math.PI/6)),i.lineTo(n-a*Math.cos(s+Math.PI/6),o-a*Math.sin(s+Math.PI/6)),i.closePath(),i.fill()}class Pe{container;timerEl;phaseEl;roundEl;scoreEl;zoomControls;countdownInterval=null;constructor(e){this.container=e,this.container.innerHTML=this.template(),this.timerEl=e.querySelector(".hud-timer"),this.phaseEl=e.querySelector(".hud-phase"),this.roundEl=e.querySelector(".hud-round"),this.scoreEl=e.querySelector(".hud-score"),this.zoomControls=e.querySelector(".zoom-controls")}template(){return`
      <div class="hud-top">
        <span class="hud-round"></span>
        <span class="hud-phase"></span>
        <span class="hud-timer"></span>
      </div>
      <div class="hud-score"></div>
      <div class="zoom-controls" aria-label="${l("zoom.controls")}">
        <button class="zoom-btn" data-action="in"  aria-label="${l("zoom.in")}">+</button>
        <button class="zoom-btn" data-action="reset" aria-label="${l("zoom.reset")}">⊙</button>
        <button class="zoom-btn" data-action="out" aria-label="${l("zoom.out")}">−</button>
      </div>
    `}bindZoom(e){this.zoomControls.addEventListener("click",t=>{const n=t.target.closest("[data-action]");if(!n)return;const o=n.getAttribute("data-action");o==="in"?e.zoomIn():o==="out"?e.zoomOut():o==="reset"&&e.reset()})}updateRound(e){this.roundEl.textContent=`${l("hud.round")} ${e}`}updatePhase(e){const t={lobby:l("phase.lobby"),planning:l("phase.planning"),resolving:l("phase.resolving"),ended:l("phase.ended")};this.phaseEl.textContent=t[e]??e,this.phaseEl.dataset.phase=e}startCountdown(e,t){this.stopCountdown();let n=e;this.timerEl.textContent=String(n),this.countdownInterval=setInterval(()=>{n--,this.timerEl.textContent=String(n),n<=0&&(this.stopCountdown(),t?.())},1e3)}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null)}updateScoreboard(e,t){const n=new Map;for(const s of t)s.ownerId&&n.set(s.ownerId,(n.get(s.ownerId)??0)+1);const o=[...e].filter(s=>!s.isEliminated).sort((s,a)=>(n.get(a.id)??0)-(n.get(s.id)??0));this.scoreEl.innerHTML=o.map(s=>`
        <span class="score-entry">
          <span class="score-dot" style="background:${s.color}"></span>
          <span class="score-name">${Te(s.name)}</span>
          <span class="score-count">${n.get(s.id)??0}</span>
        </span>
      `).join("")}}function Te(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class $e{canvas;hexRenderer;camera;myPlayerId;regions=[];orders=[];isDragging=!1;dragFrom=null;dragCurrentPixel=null;onOrderChange;onDragFrame=null;constructor(e,t,n,o,s){this.canvas=e,this.hexRenderer=t,this.camera=n,this.myPlayerId=o,this.onOrderChange=s,this.attachEvents()}updateState(e,t){this.regions=e,this.orders=t}onDrag(e){this.onDragFrame=e}attachEvents(){this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mousemove",this.onMouseMove),this.canvas.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("contextmenu",this.onContextMenu),this.canvas.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.onTouchEnd)}detach(){this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mousemove",this.onMouseMove),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("contextmenu",this.onContextMenu),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchmove",this.onTouchMove),this.canvas.removeEventListener("touchend",this.onTouchEnd)}onMouseDown=e=>{if(e.button!==0)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);!n||n.ownerId!==this.myPlayerId||(this.isDragging=!0,this.dragFrom=n,this.dragCurrentPixel=t,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors))};onMouseMove=e=>{if(!this.isDragging||!this.dragFrom)return;const t=this.canvasPos(e);this.dragCurrentPixel=t;const n=E(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)};onMouseUp=e=>{if(!this.isDragging||!this.dragFrom)return;const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&n.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(n.id)&&this.createOrUpdateOrder(this.dragFrom,n),this.endDrag()};onContextMenu=e=>{e.preventDefault();const t=this.canvasPos(e),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);n&&this.removeOrdersTo(n.id)};onTouchStart=e=>{if(e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]),n=this.hexRenderer.regionAt(t.x,t.y,this.regions);!n||n.ownerId!==this.myPlayerId||(this.isDragging=!0,this.dragFrom=n,this.hexRenderer.selectedRegionId=n.id,this.hexRenderer.highlightedRegionIds=new Set(n.neighbors))};onTouchMove=e=>{if(!this.isDragging||!this.dragFrom||e.touches.length!==1)return;e.preventDefault();const t=this.touchPos(e.touches[0]);this.dragCurrentPixel=t;const n=E(this.dragFrom.coord.q,this.dragFrom.coord.r),o=this.camera.canvasToWorld(t.x,t.y);this.onDragFrame?.(n,o)};onTouchEnd=e=>{if(!(!this.isDragging||!this.dragFrom)){if(this.dragCurrentPixel){const t=this.hexRenderer.regionAt(this.dragCurrentPixel.x,this.dragCurrentPixel.y,this.regions);t&&t.id!==this.dragFrom.id&&this.dragFrom.neighbors.includes(t.id)&&this.createOrUpdateOrder(this.dragFrom,t)}this.endDrag()}};createOrUpdateOrder(e,t){if(this.orders.find(r=>r.fromRegionId===e.id&&r.toRegionId===t.id))return;const o=this.orders.filter(r=>r.fromRegionId===e.id),s=Math.max(0,e.troops-1),a=Math.floor(s/(o.length+1));for(const r of o)r.troops=a;this.orders.push({fromRegionId:e.id,toRegionId:t.id,troops:a}),this.onOrderChange([...this.orders])}removeOrdersTo(e){this.orders=this.orders.filter(t=>t.toRegionId!==e),this.onOrderChange([...this.orders])}endDrag(){this.isDragging=!1,this.dragFrom=null,this.dragCurrentPixel=null,this.onDragFrame?.({x:0,y:0},{x:0,y:0}),this.hexRenderer.selectedRegionId=null,this.hexRenderer.highlightedRegionIds=new Set}canvasPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}touchPos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}}const De={},ke=De?.VITE_RELAY_URL??"ws://localhost:3001";X();const qe=document.getElementById("app-header"),R=document.getElementById("app-root"),ze=document.getElementById("version-history-modal"),Ye=new ne(qe,ze);let A=null;function x(){A?.(),R.innerHTML="",new ae(R,ke,(i,e,t,n)=>{A?.(),J(i,e,t,n)}),A=G(()=>{Ye.render(),x()})}function J(i,e,t,n){R.innerHTML=`
    <section class="waiting-room">
      <div class="room-code-block">
        <span class="room-code-label">Sala</span>
        <strong class="room-code">${e}</strong>
      </div>
      <div id="config-panel-mount"></div>
      <div id="player-list" class="player-list"></div>
      ${n?'<button class="btn btn-primary" id="btn-start" disabled>Iniciar partida</button>':'<button class="btn btn-secondary" id="btn-ready">Llest</button>'}
    </section>
  `;let o=null,s=!1;if(n){o=new v(i);const a=document.getElementById("config-panel-mount");new ce(a,u=>o.updateConfig(u));const r=document.getElementById("btn-start");r.addEventListener("click",()=>o.startGame()),i.on(g.PLAYER_JOINED,()=>{r.disabled=!1})}else{const a=document.getElementById("btn-ready");a.addEventListener("click",()=>{i.send(g.PLAYER_READY,{}),a.disabled=!0})}i.on(g.GAME_STATE,a=>{if(s)return;const r=a.payload;(r.phase==="planning"||r.phase==="resolving")&&(s=!0,Be(i,t,n,o))})}function Be(i,e,t,n){R.innerHTML=`
    <div class="game-layout">
      <canvas id="game-canvas" class="game-canvas"></canvas>
      <div id="hud-overlay" class="hud-overlay"></div>
    </div>
  `;const o=document.getElementById("game-canvas"),s=document.getElementById("hud-overlay");function a(){o.width=o.offsetWidth,o.height=o.offsetHeight,y()}a(),window.addEventListener("resize",a),o.addEventListener("contextmenu",p=>p.preventDefault());const r=new Ie(o,{minScale:.25,maxScale:5});r.centerOnCanvas(),r.onChange(()=>y());const u=new Oe(o,r),c=new xe(o,r),h=new Pe(s),d=new Ce(i);t&&n&&n.syncState();let m=[];const f=[];let w=null;h.bindZoom({zoomIn:()=>r.zoomIn(),zoomOut:()=>r.zoomOut(),reset:()=>{r.resetZoom(),r.centerOnCanvas()}});const S=new $e(o,u,r,e,p=>{m=p,d.localOrders=p,y()});S.onDrag((p,b)=>{const _=d.playerById(e);w=p.x!==0||b.x!==0?{from:p,to:b,color:_?.color??"#fff"}:null,y()});function y(){u.render(d.regions,d.players);const p=d.playerById(e),b=m.map(_=>({fromRegionId:_.fromRegionId,toRegionId:_.toRegionId,troops:_.troops,color:p?.color??"#fff"}));c.render([...b,...f],d.regions),w&&c.drawDragArrow(w.from,w.to,w.color)}d.on("state:updated",()=>{h.updateRound(d.round),h.updatePhase(d.phase),h.updateScoreboard(d.players,d.regions),S.updateState(d.regions,m),y()}),d.on("round:started",p=>{const{duration:b}=p;m=[],h.startCountdown(b,()=>d.submitOrders()),y()}),d.on("round:resolved",()=>{h.stopCountdown(),setTimeout(()=>y(),2200)}),d.on("game:over",p=>{const{winnerId:b}=p;window.removeEventListener("resize",a),r.detachEvents(),S.detach(),He(i,b,d,n)}),y()}function He(i,e,t,n){new le(R).show(e,t.players,t.regions,()=>J(i,i.roomCode??"",i.clientId??"",n!==null),()=>{i.disconnect(),n?.destroy(),x()})}x();
